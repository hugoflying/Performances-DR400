<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CALCULCATEUR DE PERFORMANCES</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#6b7280;--ok:#16a34a;--bad:#dc2626;--line:#e5e7eb;--primary:#2563eb;--green:#16a34a;}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial}
    h1{font-size:clamp(22px,3.5vw,30px);margin:0;text-align:center;letter-spacing:.02em}
    h2{font-size:18px;margin:0 0 .6rem 0}
    .center{text-align:center}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1200px){.row{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .btn{border:1px solid var(--line);background:#fff;padding:9px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.toggle.on{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.toggle.on.grass{background:var(--green)!important;border-color:var(--green)!important;color:#fff!important}
    label{display:block;font-size:12px;color:var(--muted)}
    input,select{width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .grid1{display:grid;grid-template-columns:1fr;gap:12px}
    .field{border:1px solid var(--line);border-radius:12px;background:#f8fafc;padding:10px}
    .field .k{font-size:12px;color:var(--muted)}
    .field .v{margin-top:4px;font-weight:600}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .footer{font-size:12px;color:var(--muted);margin-top:18px;text-align:center}
    .hidden{display:none}
    .kpi{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:16px;padding:14px 16px;margin:8px 0}
    .kpi .left{display:flex;flex-direction:column}
    .kpi .title{font-size:12px;color:var(--muted);letter-spacing:.02em}
    .kpi .value{font-size:26px;font-weight:800;line-height:1.1}
    .kpi .sub{font-size:12px;color:var(--muted)}
    .kpi.ok{background:#ecfdf5;border-color:#86efac}
    .kpi.bad{background:#fef2f2;border-color:#fecaca}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid;font-weight:800}
    .chip.ok{background:#dcfce7;color:#14532d;border-color:#86efac}
    .chip.bad{background:#fee2e2;color:#7f1d1d;border-color:#fca5a5}
    .chip.neutral{background:#f3f4f6;color:#374151;border-color:#e5e7eb}
    #printRaw{display:none}
    @media print{
      #appRoot{display:none!important}
      #printRaw{display:block!important;padding:20mm;color:#000}
      #rawPre{white-space:pre;font:12pt/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
      body{background:#fff}
    }
  </style>
</head>
<body>
<div class="container" id="appRoot">
  <div class="header" style="justify-content:center;margin-bottom:8px">
    <h1>CALCULCATEUR DE PERFORMANCES</h1>
  </div>

  <section class="card" style="margin-top:4px">
    <h2>Paramètres généraux</h2>
    <div class="grid2">
      <label>Avion
        <select id="aircraftSel">
          <option value="F-GCAL (120cv)">F-GCAL (120cv)</option>
          <option value="F-BXEK (120cv)">F-BXEK (120cv)</option>
          <option value="F-BTKG (120cv)">F-BTKG (120cv)</option>
          <option value="F-BTXS (120cv)">F-BTXS (120cv)</option>
          <option value="F-BTBS (120cv)">F-BTBS (120cv)</option>
          <option value="F-BTBJ (108cv)">F-BTBJ (108cv)</option>
        </select>
      </label>
      <label>Hélice
        <input id="propeller" value="Sensenich" readonly />
      </label>
      <label>Marge sécurité (%)
        <input id="safety" type="number" value="30"/>
      </label>
      <div class="grid1">
        <label>Carénages de roues (décollage)</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="spatsWith" class="btn toggle on">Avec carénages de roues</button>
          <button id="spatsWithout" class="btn toggle">Sans carénages de roues</button>
        </div>
      </div>
    </div>
  </section>

  <div class="row" style="margin-top:12px">
    <section class="card">
      <h2 class="center">Terrain de départ</h2>
      <div class="grid2">
        <label>ICAO départ
          <input id="depIcao" inputmode="latin" maxlength="4" placeholder="LFxx" />
        </label>
        <label>QFU départ (°)
          <input id="depQfu" type="number" value="0"/>
        </label>
        <label>TODA (m)
          <input id="depToda" type="number" value="0"/>
        </label>
        <div class="grid1">
          <label>Surface piste</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="depSurfHard" class="btn toggle on">Dur</button>
            <button id="depSurfGrass" class="btn toggle grass">Herbe</button>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>Élévation (ft)
          <input id="depAlt" type="number" value="0"/>
        </label>
        <label>OAT (°C)
          <input id="depOat" type="number" value="15"/>
        </label>
        <label>Vent — Direction (°)
          <input id="depWindDir" type="text" inputmode="numeric" pattern="[0-9]*" value="000" />
        </label>
        <label>Vent — Vitesse (kt)
          <input id="depWindKt" type="number" min="0" step="1" value="0"/>
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div class="field"><div class="k">Vent de face</div><div class="v"><span id="depHwFace">0</span> kt</div></div>
        <div class="field"><div class="k">Vent de travers</div><div class="v"><span id="depXw">0</span> kt</div></div>
        <div class="field"><div class="k">Vent arrière</div><div class="v"><span id="depTw">0</span> kt</div></div>
      </div>
      <div class="muted" id="depXwWarn" style="margin-top:6px"></div>

      <div class="grid2" style="margin-top:10px">
        <label>Facteur suppl. décollage
          <input id="depExtraTO" type="number" step="0.01" value="1.00"/>
        </label>
        <label>Masse au décollage (kg)
          <input id="depTow" type="number" value="900"/>
        </label>
      </div>
    </section>

    <section class="card">
      <h2 class="center">Terrain d'arrivée</h2>
      <div class="grid2">
        <label>ICAO arrivée
          <input id="arrIcao" inputmode="latin" maxlength="4" placeholder="LFxx" />
        </label>
        <label>QFU arrivée (°)
          <input id="arrQfu" type="number" value="0"/>
        </label>
        <label>LDA (m)
          <input id="arrLda" type="number" value="0"/>
        </label>
        <div class="grid1">
          <label>Surface piste</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="arrSurfHard" class="btn toggle on">Dur</button>
            <button id="arrSurfGrass" class="btn toggle grass">Herbe</button>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>Élévation (ft)
          <input id="arrAlt" type="number" value="0"/>
        </label>
        <label>OAT (°C)
          <input id="arrOat" type="number" value="15"/>
        </label>
        <label>Vent — Direction (°)
          <input id="arrWindDir" type="text" inputmode="numeric" pattern="[0-9]*" value="000" />
        </label>
        <label>Vent — Vitesse (kt)
          <input id="arrWindKt" type="number" min="0" step="1" value="0"/>
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div class="field"><div class="k">Vent de face</div><div class="v"><span id="arrHwFace">0</span> kt</div></div>
        <div class="field"><div class="k">Vent de travers</div><div class="v"><span id="arrXw">0</span> kt</div></div>
        <div class="field"><div class="k">Vent arrière</div><div class="v"><span id="arrTw">0</span> kt</div></div>
      </div>
      <div class="muted" id="arrXwWarn" style="margin-top:6px"></div>

      <div class="grid2" style="margin-top:10px">
        <label>Facteur suppl. atterrissage
          <input id="arrExtraLDG" type="number" step="0.01" value="1.00"/>
        </label>
        <label>Masse à l'atterrissage (kg)
          <input id="arrLdw" type="number" value="900"/>
        </label>
      </div>

      <div style="margin-top:10px">
        <label>Atterrissage — mode</label>
        <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
          <button id="arrModerate" class="btn toggle on">Freinage modéré (dur/herbe)</button>
          <button id="arrNoBrake" class="btn toggle grass">Sans frein sur herbe</button>
        </div>
      </div>
    </section>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <div class="header">
        <h2 class="center" style="width:100%">Décollage : performances calculées</h2>
        <span id="toChip" class="chip neutral">—</span>
      </div>
      <div id="toKpi" class="kpi">
        <div class="left">
          <span class="title">Requis (marge incluse)</span>
          <span class="value" id="toKpiVal">— m</span>
          <span class="sub">TODA dispo : <span id="todaMini">—</span></span>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="field"><div class="k">Passage des 15m (sans marge)</div><div id="toBasePass" class="v">—</div></div>
        <div class="field"><div class="k">Roulement (sans marge)</div><div id="toBaseRoll" class="v">—</div></div>
        <div class="field"><div class="k">Facteur vent</div><div id="toWindF" class="v">—</div></div>
        <div class="field"><div class="k">Carénages</div><div id="toSpat" class="v">—</div></div>
        <div class="field"><div class="k">Facteur supplémentaire</div><div id="toExtra" class="v">—</div></div>
        <div class="field"><div class="k">Résultat (sans marge)</div><div id="toRes" class="v">—</div></div>
        <div class="field"><div class="k">+ Marge</div><div id="toResM" class="v">—</div></div>
      </div>
    </div>

    <div class="card">
      <div class="header">
        <h2 class="center" style="width:100%">Atterrissage : performances calculées</h2>
        <span id="ldgChip" class="chip neutral">—</span>
      </div>
      <div id="ldgKpi" class="kpi">
        <div class="left">
          <span class="title">Requis (marge incluse)</span>
          <span class="value" id="ldgKpiVal">— m</span>
          <span class="sub">LDA dispo : <span id="ldaMini">—</span></span>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="field"><div class="k">Passage des 15m (sans marge)</div><div id="ldgBasePass" class="v">—</div></div>
        <div class="field"><div class="k">Roulement (sans marge)</div><div id="ldgBaseRoll" class="v">—</div></div>
        <div class="field"><div class="k">Facteur vent</div><div id="ldgWindF" class="v">—</div></div>
        <div class="field"><div class="k">Facteur supplémentaire</div><div id="ldgExtra" class="v">—</div></div>
        <div class="field"><div class="k">Résultat (sans marge)</div><div id="ldgRes" class="v">—</div></div>
        <div class="field"><div class="k">+ Marge</div><div id="ldgResM" class="v">—</div></div>
      </div>
    </div>
  </div>

  <div class="footer">Source : Manuel de vol - Aéroclub de Beauvais-Tillé</div>
</div>

<section id="printRaw"><pre id="rawPre"></pre></section>

<script>
  /* ===================== DONNÉES ===================== */
  // DR400-120 (F-GCAL) — tables existantes (STD±20) [inchangé]
  const TO_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},hard:{kg700:{roll:[130,145,165],pass:[285,315,345]},kg900:{roll:[225,235,285],pass:[480,535,590]}},grass:{kg700:{roll:[165,185,215],pass:[320,355,395]},kg900:{roll:[315,360,410],pass:[570,640,715]}}},4000:{temps:{minus20:-13,isa:7,plus20:27},hard:{kg700:{roll:[175,195,220],pass:[375,415,460]},kg900:{roll:[305,345,390],pass:[645,720,800]}},grass:{kg700:{roll:[230,265,300],pass:[430,485,540]},kg900:{roll:[460,530,615],pass:[800,905,1025]}}},8000:{temps:{minus20:-21,isa:-1,plus20:19},hard:{kg700:{roll:[235,265,300],pass:[500,560,620]},kg900:{roll:[425,475,535],pass:[890,1000,1125]}},grass:{kg700:{roll:[330,380,440],pass:[595,675,760]},kg900:{roll:[700,820,960],pass:[1165,1350,1550]}}}};
  const LDG_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},moderate:{kg700:{roll:[145,155,165],pass:[365,385,400]},kg900:{roll:[185,200,210],pass:[435,460,485]}},nobrake_grass:{kg700:{roll:[215,230,250],pass:[435,460,485]},kg900:{roll:[280,300,325],pass:[530,560,590]}}},4000:{temps:{minus20:-13,isa:7,plus20:27},moderate:{kg700:{roll:[160,175,185],pass:[395,420,440]},kg900:{roll:[205,225,240],pass:[475,505,535]}},nobrake_grass:{kg700:{roll:[240,260,285],pass:[475,505,530]},kg900:{roll:[310,335,360],pass:[580,615,655]}}},8000:{temps:{minus20:-21,isa:-1,plus20:19},moderate:{kg700:{roll:[180,195,210],pass:[430,460,485]},kg900:{roll:[235,250,270],pass:[525,555,590]}},nobrake_grass:{kg700:{roll:[275,290,315],pass:[525,555,590]},kg900:{roll:[350,375,405],pass:[640,680,725]}}}};

  // DR300-120 (F-BTKG, F-BTXS) — Décollage uniquement (roulement & 15 m)
  // Temp columns: 0°, 15°, 30°, 45°
  // Alt béton: 0,1500,3000,4500 ; Alt herbe: 0,1500,3000,4600
  const DR300_TEMPS=[0,15,30,45];
  const TO_DR300 = {
    hard: {
      alts:[0,1500,3000,4500],
      roll: [
        [315,350,390,430],
        [330,360,400,460],
        [385,430,475,520],
        [430,480,520,560],
      ],
      pass: [
        [530,590,655,720],
        [605,675,745,820],
        [685,765,845,920],
        [760,845,935,1020],
      ],
    },
    grass: {
      alts:[0,1500,3000,4600],
      roll: [
        [380,420,470,515],
        [420,470,515,575],
        [455,510,570,625],
        [510,575,635,695],
      ],
      pass: [
        [595,660,735,805],
        [675,745,820,895],
        [760,850,935,1025],
        [845,940,1040,1135],
      ],
    },
    // mise à l'échelle masse (<1000 kg) : facteur = masse/1000 (capé à 1)
    massScale: m => Math.min(1, m/1000)
  };

  /* ===================== UTILITAIRES ===================== */
  const $=s=>document.querySelector(s);
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const lerp=(x0,y0,x1,y1,x)=> y0 + (y1-y0)*((x-x0)/(x1-x0||1));
  const pad3=n=>String(Math.round(n)).padStart(3,'0');

  // Interp DR400 (ISA-based)
  function interpTemp(rowTemps,arr,oat){
    const xs=[rowTemps.minus20,rowTemps.isa,rowTemps.plus20],ys=arr;
    if(oat<=xs[0])return ys[0]; if(oat>=xs[2])return ys[2];
    if(oat<=xs[1])return lerp(xs[0],ys[0],xs[1],ys[1],oat);
    return lerp(xs[1],ys[1],xs[2],ys[2],oat);
  }
  function interpTO_DR400(altFt,oat,massKg,surface,kind){
    const low=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    const high=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    const alpha=clamp((massKg-700)/(900-700),0,1);
    const valAt=alt=>{
      const t=TO_DR400[alt];
      const v700=interpTemp(t.temps,t[surface].kg700[kind],oat);
      const v900=interpTemp(t.temps,t[surface].kg900[kind],oat);
      return lerp(0,v700,1,v900,alpha);
    };
    if(low===high)return valAt(low);
    return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function interpLDG_DR400(altFt,oat,massKg,mode,kind){
    const low=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    const high=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    const alpha=clamp((massKg-700)/(900-700),0,1);
    const valAt=alt=>{
      const t=LDG_DR400[alt];
      const v700=interpTemp(t.temps,t[mode].kg700[kind],oat);
      const v900=interpTemp(t.temps,t[mode].kg900[kind],oat);
      return lerp(0,v700,1,v900,alpha);
    };
    if(low===high)return valAt(low);
    return lerp(low,valAt(low),high,valAt(high),altFt);
  }

  // Interp DR300 (axes fixes alt×temp)
  function interpGridDR300(surface,kind,altFt,oat,massKg){
    const surf=TO_DR300[surface];
    const temps=DR300_TEMPS;
    const alts=surf.alts;
    // Interp T pour chaque palier d'altitude
    function interpRow(row){
      const ys=row;
      const x=oat;
      if(x<=temps[0])return ys[0];
      if(x>=temps[3])return ys[3];
      if(x<=temps[1])return lerp(temps[0],ys[0],temps[1],ys[1],x);
      if(x<=temps[2])return lerp(temps[1],ys[1],temps[2],ys[2],x);
      return lerp(temps[2],ys[2],temps[3],ys[3],x);
    }
    // Trouver 2 altitudes encadrantes
    let a0=alts[0], a1=alts[alts.length-1];
    for(let i=0;i<alts.length-1;i++){
      if(altFt<=alts[0]){a0=a1=alts[0];break;}
      if(altFt>=alts[alts.length-1]){a0=a1=alts[alts.length-1];break;}
      if(altFt>=alts[i] && altFt<=alts[i+1]){a0=alts[i];a1=alts[i+1];break;}
    }
    const idx0=alts.indexOf(a0), idx1=alts.indexOf(a1);
    const v0=interpRow(surf[kind][idx0]);
    const v1=interpRow(surf[kind][idx1]);
    let val = (a0===a1)? v0 : lerp(a0,v0,a1,v1,altFt);
    // Mise à l'échelle masse (<1000 kg)
    val = val * TO_DR300.massScale(massKg);
    return val;
  }

  // Vent
  function windComponents(qfu,windDir,windKt){
    const diff=((windDir-qfu+540)%360)-180;
    const rad=diff*Math.PI/180;
    return{headwind:windKt*Math.cos(rad),crosswind:windKt*Math.sin(rad)};
  }
  function headwindFactorFace(hw){
    const pts=[{x:0,y:1.00},{x:10,y:0.78},{x:20,y:0.63},{x:30,y:0.52}],x=Math.max(0,Math.min(30,hw));
    if(x===0)return 1;
    for(let i=0;i<pts.length-1;i++){const p0=pts[i],p1=pts[i+1];if(x>=p0.x&&x<=p1.x)return p0.y+(p1.y-p0.y)*((x-p0.x)/(p1.x-p0.x))}
    return pts.at(-1).y;
  }
  function windDistanceFactor(headwind){
    if(headwind>=0)return headwindFactorFace(headwind);
    const tw=Math.abs(headwind),steps=Math.ceil(tw/2);
    return 1+0.10*steps;
  }
  function setChip(el,state){el.className='chip '+(state==='ok'?'ok':state==='bad'?'bad':'neutral');el.textContent=state==='ok'?'OK':state==='bad'?'KO':'—'}
  function setKpi(el,state){el.className='kpi '+(state==='ok'?'ok':state==='bad'?'bad':'')}
  function status(val,limit){if(!limit)return'neutral';return val<=limit?'ok':'bad'}

  /* ===================== LOGIQUE UI ===================== */
  let depSurface='hard',arrSurface='hard',landingMode='moderate',withSpats=true, profile='DR400';

  // Sélection avion → hélice + profil (DR400 ou DR300)
  const propByAircraft={
    'F-GCAL (120cv)':'Sensenich',
    'F-BXEK (120cv)':'Sensenich',
    'F-BTKG (120cv)':'Sensenich',
    'F-BTXS (120cv)':'Sensenich',
    'F-BTBS (120cv)':'Mac Cauley',
    'F-BTBJ (108cv)':'Mac Cauley'
  };
  function onAircraftChange(){
    const ac=$('#aircraftSel').value;
    $('#propeller').value=propByAircraft[ac]||'';
    profile = (ac.startsWith('F-BTKG') || ac.startsWith('F-BTXS')) ? 'DR300' : 'DR400';
    compute();
  }
  $('#aircraftSel').addEventListener('change', onAircraftChange);
  onAircraftChange();

  function sanitizeIcao(el){el.value=(el.value||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,4)}
  ['depIcao','arrIcao'].forEach(id=>{
    const el=$('#'+id);
    el.addEventListener('input',()=>{sanitizeIcao(el);compute()});
    el.addEventListener('blur',()=>sanitizeIcao(el));
  });

  // Toggles
  $('#depSurfHard').onclick=()=>{depSurface='hard';$('#depSurfHard').classList.add('on');$('#depSurfGrass').classList.remove('on');compute()};
  $('#depSurfGrass').onclick=()=>{depSurface='grass';$('#depSurfGrass').classList.add('on');$('#depSurfHard').classList.remove('on');compute()};
  $('#arrSurfHard').onclick=()=>{arrSurface='hard';$('#arrSurfHard').classList.add('on');$('#arrSurfGrass').classList.remove('on');compute()};
  $('#arrSurfGrass').onclick=()=>{arrSurface='grass';$('#arrSurfGrass').classList.add('on');$('#arrSurfHard').classList.remove('on');compute()};
  $('#arrModerate').onclick=()=>{landingMode='moderate';$('#arrModerate').classList.add('on');$('#arrNoBrake').classList.remove('on');compute()};
  $('#arrNoBrake').onclick=()=>{landingMode='nobrake_grass';$('#arrNoBrake').classList.add('on');$('#arrModerate').classList.remove('on');compute()};
  $('#spatsWith').onclick=()=>{withSpats=true;$('#spatsWith').classList.add('on');$('#spatsWithout').classList.remove('on');compute()};
  $('#spatsWithout').onclick=()=>{withSpats=false;$('#spatsWithout').classList.add('on');$('#spatsWith').classList.remove('on');compute()};

  // Direction vent (format "000"… "350")
  function bindDir(id){
    const el=$('#'+id);
    const clampDir=v=>{if(isNaN(v))v=0;v=Math.round(v);if(v<0)v=0;if(v>350)v=350;return v;}
    const normalizeDigits=()=>{el.value=el.value.replace(/\D/g,'').slice(0,3);}
    const format=()=>{let v=clampDir(parseInt(el.value,10));el.value=pad3(v);return v;}
    el.addEventListener('input',()=>{normalizeDigits();compute()});
    el.addEventListener('blur',()=>{format();compute()});
    el.addEventListener('change',()=>{format();compute()});
    el.addEventListener('keydown',e=>{
      if(e.key==='ArrowUp'||e.key==='ArrowDown'){
        e.preventDefault(); let v=clampDir(parseInt(el.value||'0',10)); v+=(e.key==='ArrowUp'?+1:-1);
        if(v<0)v=350; if(v>350)v=0; el.value=pad3(v); compute();
      }
    });
  }
  bindDir('depWindDir'); bindDir('arrWindDir');

  // Vitesse vent: entier ≥0
  function bindSpeed(id){
    const el=$('#'+id);
    const norm=()=>{let v=Math.round(Number(el.value)); if(!isFinite(v)||v<0)v=0; el.value=String(v);}
    el.addEventListener('input',()=>{norm();compute()});
    el.addEventListener('blur',()=>{norm();compute()});
    el.addEventListener('keydown',e=>{
      if(e.key==='ArrowDown'){let v=parseInt(el.value||'0',10); if(isNaN(v))v=0; if(v<=0){e.preventDefault(); el.value='0';}}
    });
  }
  bindSpeed('depWindKt'); bindSpeed('arrWindKt');

  // Inputs → compute
  ['safety','depQfu','depToda','depAlt','depOat','depExtraTO','depTow',
   'arrQfu','arrLda','arrAlt','arrOat','arrExtraLDG','arrLdw'
  ].forEach(id=>$('#'+id).addEventListener('input', compute));

  /* ===================== CALCUL ===================== */
  function compute(){
    const depQfu=+($('#depQfu').value||0), depToda=+($('#depToda').value||0),
          depAlt=+($('#depAlt').value||0), depOat=+($('#depOat').value||0),
          depWdir=parseInt($('#depWindDir').value||'0',10), depWkt=+($('#depWindKt').value||0),
          depExtra=+($('#depExtraTO').value||1), depTow=+($('#depTow').value||900);
    const arrQfu=+($('#arrQfu').value||0), arrLda=+($('#arrLda').value||0),
          arrAlt=+($('#arrAlt').value||0), arrOat=+($('#arrOat').value||0),
          arrWdir=parseInt($('#arrWindDir').value||'0',10), arrWkt=+($('#arrWindKt').value||0),
          arrExtra=+($('#arrExtraLDG').value||1), arrLdw=+($('#arrLdw').value||900);
    const safety=+($('#safety').value||30);

    const depComp=windComponents(depQfu,depWdir,depWkt), arrComp=windComponents(arrQfu,arrWdir,arrWkt);
    const depHw=depComp.headwind, depXw=Math.abs(depComp.crosswind);
    const arrHw=arrComp.headwind, arrXw=Math.abs(arrComp.crosswind);
    const depHwFace=Math.max(0,depHw), depTw=Math.max(0,-depHw);
    const arrHwFace=Math.max(0,arrHw), arrTw=Math.max(0,-arrHw);

    $('#depHwFace').textContent=depHwFace.toFixed(0); $('#depXw').textContent=depXw.toFixed(0); $('#depTw').textContent=depTw.toFixed(0);
    $('#arrHwFace').textContent=arrHwFace.toFixed(0); $('#arrXw').textContent=arrXw.toFixed(0); $('#arrTw').textContent=arrTw.toFixed(0);

    const crossLimit=22;
    const depWarn=$('#depXwWarn'), arrWarn=$('#arrXwWarn');
    depWarn.textContent=depXw>crossLimit?`⚠️ ${depXw.toFixed(0)} kt > ${crossLimit} kt (limite DR400)`:''; depWarn.style.color=depXw>crossLimit?'#dc2626':'var(--muted)';
    arrWarn.textContent=arrXw>crossLimit?`⚠️ ${arrXw.toFixed(0)} kt > ${crossLimit} kt (limite DR400)`:''; arrWarn.style.color=arrXw>crossLimit?'#dc2626':'var(--muted)';

    // ----- TO base values by profile -----
    let baseTO_pass, baseTO_roll;
    if(profile==='DR300'){
      baseTO_pass = interpGridDR300(depSurface,'pass',depAlt,depOat,depTow);
      baseTO_roll = interpGridDR300(depSurface,'roll',depAlt,depOat,depTow);
    }else{
      baseTO_pass = interpTO_DR400(depAlt,depOat,depTow,depSurface,'pass');
      baseTO_roll = interpTO_DR400(depAlt,depOat,depTow,depSurface,'roll');
    }

    // ----- LDG (on garde le profil DR400 pour l’instant) -----
    const baseLDG_pass = interpLDG_DR400(arrAlt,arrOat,arrLdw,landingMode,'pass');
    const baseLDG_roll = interpLDG_DR400(arrAlt,arrOat,arrLdw,landingMode,'roll');

    const depWindF=windDistanceFactor(depHw);
    const arrWindF=windDistanceFactor(arrHw);
    const spatsF=withSpats?1.00:1.03;

    const toCalc=Math.round(baseTO_pass*depWindF*depExtra*spatsF);
    const ldgCalc=Math.round(baseLDG_pass*arrWindF*arrExtra);
    const toMargin=Math.round(toCalc*(1+safety/100));
    const ldgMargin=Math.round(ldgCalc*(1+safety/100));

    $('#toBasePass').textContent=Math.round(baseTO_pass)+' m';
    $('#toBaseRoll').textContent=Math.round(baseTO_roll)+' m';
    $('#toWindF').textContent=depWindF.toFixed(2)+'×';
    $('#toSpat').textContent=`${spatsF.toFixed(2)}×`+(spatsF===1?' (carénages présents)':' (sans carénages)');
    $('#toExtra').textContent=depExtra.toFixed(2)+'×';
    $('#toRes').textContent=toCalc+' m';
    $('#toResM').textContent=toMargin+' m';
    $('#todaMini').textContent=depToda?depToda+' m':'—';

    $('#ldgBasePass').textContent=Math.round(baseLDG_pass)+' m';
    $('#ldgBaseRoll').textContent=Math.round(baseLDG_roll)+' m';
    $('#ldgWindF').textContent=arrWindF.toFixed(2)+'×';
    $('#ldgExtra').textContent=arrExtra.toFixed(2)+'×';
    $('#ldgRes').textContent=ldgCalc+' m';
    $('#ldgResM').textContent=ldgMargin+' m';
    $('#ldaMini').textContent=arrLda?arrLda+' m':'—';

    const stTO=(depToda? (toMargin<=depToda?'ok':'bad'):'neutral');
    const stLDG=(arrLda? (ldgMargin<=arrLda?'ok':'bad'):'neutral');
    setChip($('#toChip'),stTO); setChip($('#ldgChip'),stLDG);
    setKpi($('#toKpi'),stTO); setKpi($('#ldgKpi'),stLDG);
    $('#toKpiVal').textContent=toMargin+' m'; $('#ldgKpiVal').textContent=ldgMargin+' m';
  }

  // Impression brute
  function buildRawReport(){
    const safety=+($('#safety').value||30);
    const aircraft=$('#aircraftSel').value;
    const prop=$('#propeller').value;
    const spats=$('#spatsWith').classList.contains('on')?'Avec carénages':'Sans carénages (+3% TO)';

    const D={ icao:($('#depIcao').value||'').toUpperCase(), qfu:+($('#depQfu').value||0), toda:+($('#depToda').value||0),
              alt:+($('#depAlt').value||0), oat:+($('#depOat').value||0),
              wdir:parseInt($('#depWindDir').value||'0',10), wkt:+($('#depWindKt').value||0),
              extra:+($('#depExtraTO').value||1), mass:+($('#depTow').value||900),
              surface:($('#depSurfGrass').classList.contains('on')?'Herbe':'Dur') };
    const A={ icao:($('#arrIcao').value||'').toUpperCase(), qfu:+($('#arrQfu').value||0), lda:+($('#arrLda').value||0),
              alt:+($('#arrAlt').value||0), oat:+($('#arrOat').value||0),
              wdir:parseInt($('#arrWindDir').value||'0',10), wkt:+($('#arrWindKt').value||0),
              extra:+($('#arrExtraLDG').value||1), mass:+($('#arrLdw').value||900),
              surface:($('#arrSurfGrass').classList.contains('on')?'Herbe':'Dur'),
              mode:($('#arrNoBrake').classList.contains('on')?'Sans frein herbe':'Freinage modéré') };

    const depComp=windComponents(D.qfu,D.wdir,D.wkt), arrComp=windComponents(A.qfu,A.wdir,A.wkt);
    const depHw=depComp.headwind, arrHw=arrComp.headwind;

    // Recalcule bases pour report
    const baseTO_pass = (profile==='DR300')
      ? interpGridDR300(D.surface==='Herbe'?'grass':'hard','pass',D.alt,D.oat,D.mass)
      : interpTO_DR400(D.alt,D.oat,D.mass,D.surface==='Herbe'?'grass':'hard','pass');
    const baseTO_roll = (profile==='DR300')
      ? interpGridDR300(D.surface==='Herbe'?'grass':'hard','roll',D.alt,D.oat,D.mass)
      : interpTO_DR400(D.alt,D.oat,D.mass,D.surface==='Herbe'?'grass':'hard','roll');

    const baseLDG_pass=interpLDG_DR400(A.alt,A.oat,A.mass,(A.mode.startsWith('Sans')?'nobrake_grass':'moderate'),'pass');
    const baseLDG_roll=interpLDG_DR400(A.alt,A.oat,A.mass,(A.mode.startsWith('Sans')?'nobrake_grass':'moderate'),'roll');

    const depWindF=windDistanceFactor(depHw), arrWindF=windDistanceFactor(arrHw);
    const spatsF=spats.startsWith('Avec')?1.00:1.03;

    const toCalc=Math.round(baseTO_pass*depWindF*D.extra*spatsF);
    const ldgCalc=Math.round(baseLDG_pass*arrWindF*A.extra);
    const toMargin=Math.round(toCalc*(1+safety/100));
    const ldgMargin=Math.round(ldgCalc*(1+safety/100));

    const stTO=(D.toda?(toMargin<=D.toda?'OK':'KO'):'—');
    const stLDG=(A.lda?(ldgMargin<=A.lda?'OK':'KO'):'—');

    const ts=new Date().toLocaleString('fr-FR');

    return [
      `CALCULCATEUR DE PERFORMANCES`,
      `Horodatage : ${ts}`,
      ``,
      `[Paramètres généraux]`,
      `  Avion : ${aircraft}    Hélice : ${prop}    Profil : ${profile}`,
      `  Marge sécurité : ${safety}%`,
      `  Carénages : ${spats}`,
      ``,
      `[Départ]`,
      `  ICAO : ${D.icao}    QFU : ${D.qfu}°    Surface : ${D.surface}`,
      `  Élévation : ${D.alt} ft    OAT : ${D.oat} °C`,
      `  Vent : ${String(D.wdir).padStart(3,'0')}°/${Math.round(D.wkt)} kt  → Face ${Math.max(0,depHw).toFixed(0)} kt | Travers ${Math.abs(depComp.crosswind).toFixed(0)} kt | Arrière ${Math.max(0,-depHw).toFixed(0)} kt`,
      `  Masse décollage : ${D.mass} kg`,
      `  Base roul. : ${Math.round(baseTO_roll)} m    Base 15 m : ${Math.round(baseTO_pass)} m`,
      `  Facteurs : Vent ${depWindF.toFixed(2)}×  · Carénages ${spatsF.toFixed(2)}×  · Suppl. ${D.extra.toFixed(2)}×`,
      `  Résultat 15 m : ${toCalc} m    + Marge ${safety}% → ${toMargin} m`,
      `  TODA dispo : ${D.toda||'—'} m    Statut : ${stTO}`,
      ``,
      `[Arrivée]`,
      `  ICAO : ${A.icao}    QFU : ${A.qfu}°    Surface : ${A.surface}`,
      `  Mode : ${A.mode}`,
      `  Élévation : ${A.alt} ft    OAT : ${A.oat} °C`,
      `  Vent : ${String(A.wdir).padStart(3,'0')}°/${Math.round(A.wkt)} kt  → Face ${Math.max(0,arrHw).toFixed(0)} kt | Travers ${Math.abs(arrComp.crosswind).toFixed(0)} kt | Arrière ${Math.max(0,-arrHw).toFixed(0)} kt`,
      `  Masse atterrissage : ${A.mass} kg`,
      `  Base roul. : ${Math.round(baseLDG_roll)} m    Base 15 m : ${Math.round(baseLDG_pass)} m`,
      `  Facteurs : Vent ${arrWindF.toFixed(2)}×  · Suppl. ${A.extra.toFixed(2)}×`,
      `  Résultat 15 m : ${ldgCalc} m    + Marge ${safety}% → ${ldgMargin} m`,
      `  LDA dispo : ${A.lda||'—'} m    Statut : ${stLDG}`,
    ].join('\n');
  }
  window.addEventListener('beforeprint', ()=>{document.getElementById('rawPre').textContent = buildRawReport();});
  compute();
</script>
</body>
</html>
