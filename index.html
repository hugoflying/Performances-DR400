<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CALCULCATEUR DE PERFORMANCES</title>
  <style>
    :root{
      --bg:#e5e7eb; /* fond un peu plus foncé */
      --card:#fff;--ink:#0f172a;--muted:#6b7280;--ok:#16a34a;--bad:#dc2626;
      --line:#d1d5db;--primary:#2563eb;--green:#16a34a;
      --warn-yellow-bg:#fff7ed; --warn-yellow-border:#fbbf24;
      --warn-red-bg:#fef2f2; --warn-red-border:#ef4444;
      --banner:#0b1f5e; /* bleu de bannière plus foncé */
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial}
    h1{font-size:clamp(22px,3.5vw,30px);margin:0;text-align:center;letter-spacing:.02em}
    h2{font-size:18px;margin:0 0 .6rem 0}
    .center{text-align:center}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1200px){.row{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .btn{border:1px solid var(--line);background:#fff;padding:9px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.toggle.on{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.toggle.on.grass{background:var(--green)!important;border-color:var(--green)!important;color:#fff!important}
    .btn.block{width:100%;text-align:center;padding:12px 14px;border-radius:14px}
    label{display:block;font-size:12px;color:var(--muted)}
    input,select{width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .grid1{display:grid;grid-template-columns:1fr;gap:12px}
    .inline{display:flex;gap:8px;align-items:flex-end}
    .inline > label{flex:1}
    .field{border:1px solid var(--line);border-radius:12px;background:#f8fafc;padding:10px}
    .field .k{font-size:12px;color:var(--muted)}
    .field .v{margin-top:4px;font-weight:600}
    .field.warn-yellow{background:var(--warn-yellow-bg);border-color:var(--warn-yellow-border)}
    .field.warn-red{background:var(--warn-red-bg);border-color:var(--warn-red-border)}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .note{font-size:12px;margin-top:6px}
    .mini-note{font-size:11px}
    .hidden{display:none}
    .kpi{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:16px;padding:14px 16px;margin:8px 0}
    .kpi .left{display:flex;flex-direction:column}
    .kpi .title{font-size:12px;color:var(--muted);letter-spacing:.02em}
    .kpi .value{font-size:26px;font-weight:800;line-height:1.1}
    .kpi .sub{font-size:12px;color:var(--muted)}
    .kpi.ok{background:#ecfdf5;border-color:#86efac}
    .kpi.bad{background:#fef2f2;border-color:#fecaca}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid;font-weight:800}
    .chip.ok{background:#dcfce7;color:#14532d;border-color:#86efac}
    .chip.bad{background:#fee2e2;color:#7f1d1d;border-color:#fca5a5}
    .chip.neutral{background:#f3f4f6;color:#374151;border-color:#e5e7eb}
    #printRaw{display:none}
    .vrbFlex{display:flex;gap:8px;align-items:center}
    .vrbFlex input{flex:1}
    .vrbSep{font-weight:700;color:#6b7280}
    .banner{background:var(--banner);color:#fff;border-radius:14px;padding:14px 16px;margin-bottom:8px}
    .rowline{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;margin-top:10px}
    .rowline .group{display:flex;flex-direction:column;gap:8px;flex-basis:48%;align-items:center}
    .group .buttons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    @media print{
      #appRoot{display:none!important}
      #printRaw{display:block!important;padding:20mm;color:#000}
      #rawPre{white-space:pre;font:12pt/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
      body{background:#fff}
    }
  </style>
</head>
<body>
<div class="container" id="appRoot">
  <div class="banner">
    <h1>CALCULCATEUR DE PERFORMANCES</h1>
  </div>

  <section class="card" style="margin-top:4px">
    <h2>Paramètres généraux</h2>
    <div class="grid2">
      <label>Avion
        <select id="aircraftSel">
          <option value="F-GCAL (120cv)">F-GCAL (120cv)</option>
          <option value="F-BXEK (120cv)">F-BXEK (120cv)</option>
          <option value="F-BTKG (120cv)">F-BTKG (120cv)</option>
          <option value="F-BTXS (120cv)">F-BTXS (120cv)</option>
          <option value="F-BTBS (120cv)">F-BTBS (120cv)</option>
          <option value="F-BTBJ (108cv)">F-BTBJ (108cv)</option>
        </select>
      </label>
      <label>Hélice
        <input id="propeller" value="Sensenich" readonly />
      </label>
      <label>Marge sécurité (%)
        <input id="safety" type="number" value="30"/>
      </label>
    </div>
  </section>

  <div class="row" style="margin-top:12px">
    <!-- Départ -->
    <section class="card">
      <h2 class="center">Terrain de départ</h2>

      <div class="inline">
        <label>ICAO départ
          <input id="depIcao" inputmode="latin" maxlength="4" placeholder="LFxx" />
        </label>
        <button id="btnDepMetar" class="btn">Charger METAR</button>
      </div>
      <div id="depMetarMsg" class="muted note"></div>

      <div class="grid2" style="margin-top:10px">
        <label>QFU départ (°)
          <input id="depQfu" type="text" placeholder="001–360"/>
        </label>
        <label>TODA (m)
          <input id="depToda" type="text" inputmode="numeric" />
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <label>Vent — Direction (° ou "VRB")
          <input id="depWindDir" list="dirOptions" type="text" inputmode="latin" placeholder="VRB ou 000" value="000" />
        </label>
        <label>OAT (°C)
          <input id="depOat" type="number" value="15"/>
        </label>
        <label>Secteur VRB (optionnel)
          <div class="vrbFlex">
            <input id="depVrbFrom" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="FROM"/>
            <span class="vrbSep">V</span>
            <input id="depVrbTo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="TO"/>
          </div>
        </label>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>Vent — Vitesse (kt)
          <input id="depWindKt" type="number" min="0" step="1" value="0"/>
        </label>
        <label>Rafales (kt)
          <input id="depWindGust" type="number" min="0" step="1" value="0"/>
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div class="field"><div class="k">Vent de face</div><div class="v"><span id="depHwFace">—</span> kt</div></div>
        <div id="depXwCard" class="field"><div class="k">Vent de travers</div><div class="v"><span id="depXw">—</span> kt</div></div>
        <div class="field"><div class="k">Vent arrière</div><div class="v"><span id="depTw">—</span> kt</div></div>
      </div>

      <!-- Carénages + Surface : titres au-dessus, boutons centrés -->
      <div class="rowline">
        <div class="group">
          <label>Carénages de roues</label>
          <div class="buttons">
            <button id="spatsWith" class="btn toggle on">Avec</button>
            <button id="spatsWithout" class="btn toggle">Sans</button>
          </div>
        </div>
        <div class="group">
          <label>Surface piste</label>
          <div class="buttons">
            <button id="depSurfHard" class="btn toggle on">Dur</button>
            <button id="depSurfGrass" class="btn toggle grass">Herbe</button>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <label>Masse au décollage (kg)
          <input id="depTow" type="number" value="900"/>
        </label>
        <label>Facteur suppl. décollage
          <input id="depExtraTO" type="number" step="0.01" value="1.00"/>
        </label>
      </div>

      <button id="btnCalcDep" class="btn primary block" style="margin-top:14px">Calculer les performances décollage</button>
    </section>

    <!-- Arrivée -->
    <section class="card">
      <h2 class="center">Terrain d'arrivée</h2>

      <div class="inline">
        <label>ICAO arrivée
          <input id="arrIcao" inputmode="latin" maxlength="4" placeholder="LFxx" />
        </label>
        <button id="btnArrMetar" class="btn">Charger METAR</button>
      </div>
      <div id="arrMetarMsg" class="muted note"></div>

      <div class="grid2" style="margin-top:10px">
        <label>QFU arrivée (°)
          <input id="arrQfu" type="text" placeholder="001–360"/>
        </label>
        <label>LDA (m)
          <input id="arrLda" type="text" inputmode="numeric" />
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <label>Vent — Direction (° ou "VRB")
          <input id="arrWindDir" list="dirOptions" type="text" inputmode="latin" placeholder="VRB ou 000" value="000" />
        </label>
        <label>OAT (°C)
          <input id="arrOat" type="number" value="15"/>
        </label>
        <label>Secteur VRB (optionnel)
          <div class="vrbFlex">
            <input id="arrVrbFrom" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="FROM"/>
            <span class="vrbSep">V</span>
            <input id="arrVrbTo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="TO"/>
          </div>
        </label>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>Vent — Vitesse (kt)
          <input id="arrWindKt" type="number" min="0" step="1" value="0"/>
        </label>
        <label>Rafales (kt)
          <input id="arrWindGust" type="number" min="0" step="1" value="0"/>
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div class="field"><div class="k">Vent de face</div><div class="v"><span id="arrHwFace">—</span> kt</div></div>
        <div id="arrXwCard" class="field"><div class="k">Vent de travers</div><div class="v"><span id="arrXw">—</span> kt</div></div>
        <div class="field"><div class="k">Vent arrière</div><div class="v"><span id="arrTw">—</span> kt</div></div>
      </div>

      <div class="grid1" style="margin-top:10px">
        <label>Type de freinage</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
          <button id="arrModerate" class="btn toggle on">Freinage modéré (dur/herbe)</button>
          <button id="arrNoBrake" class="btn toggle grass">Sans frein sur herbe</button>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <label>Masse à l'atterrissage (kg)
          <input id="arrLdw" type="number" value="900"/>
        </label>
        <label>Facteur suppl. atterrissage
          <input id="arrExtraLDG" type="number" step="0.01" value="1.00"/>
        </label>
      </div>

      <button id="btnCalcArr" class="btn primary block" style="margin-top:14px">Calculer les performances atterrissage</button>
    </section>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <div class="header">
        <h2 class="center" style="width:100%">Décollage : performances calculées</h2>
        <span id="toChip" class="chip neutral">—</span>
      </div>
      <div id="toKpi" class="kpi">
        <div class="left">
          <span class="title">Requis (marge incluse)</span>
          <span class="value" id="toKpiVal">— m</span>
          <span class="sub">TODA dispo : <span id="todaMini">—</span></span>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="field"><div class="k">Passage des 15m (sans marge)</div><div id="toBasePass" class="v">—</div></div>
        <div class="field"><div class="k">Roulement (sans marge)</div><div id="toBaseRoll" class="v">—</div></div>
        <div class="field"><div class="k">Facteur vent</div><div id="toWindF" class="v">—</div></div>
        <div class="field"><div class="k">Carénages</div><div id="toSpat" class="v">—</div></div>
        <div class="field"><div class="k">Facteur supplémentaire</div><div id="toExtra" class="v">—</div></div>
        <div class="field"><div class="k">Résultat</div><div id="toRes" class="v">—</div></div>
      </div>
      <div id="toExplain" class="muted mini-note"></div>
    </div>

    <div class="card">
      <div class="header">
        <h2 class="center" style="width:100%">Atterrissage : performances calculées</h2>
        <span id="ldgChip" class="chip neutral">—</span>
      </div>
      <div id="ldgKpi" class="kpi">
        <div class="left">
          <span class="title">Requis (marge incluse)</span>
          <span class="value" id="ldgKpiVal">— m</span>
          <span class="sub">LDA dispo : <span id="ldaMini">—</span></span>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="field"><div class="k">Passage des 15m (sans marge)</div><div id="ldgBasePass" class="v">—</div></div>
        <div class="field"><div class="k">Roulement (sans marge)</div><div id="ldgBaseRoll" class="v">—</div></div>
        <div class="field"><div class="k">Facteur vent</div><div id="ldgWindF" class="v">—</div></div>
        <div class="field"><div class="k">Facteur supplémentaire</div><div id="ldgExtra" class="v">—</div></div>
        <div class="field"><div class="k">Résultat</div><div id="ldgRes" class="v">—</div></div>
      </div>
      <div id="ldgExplain" class="muted mini-note"></div>
    </div>
  </div>

  <div class="muted center" style="margin-top:12px;font-size:11px">
    <div>Source : Manuel de vol respectif de chaque avion - Aéroclub de Beauvais-Tillé</div>
    <div>Développé par Hugo DERUELLE avec l'aide de l'IA</div>
  </div>
</div>

<datalist id="dirOptions">
  <option value="VRB"></option>
</datalist>

<section id="printRaw"><pre id="rawPre"></pre></section>

<script>
  /* ===================== DONNÉES ===================== */
  const TO_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},hard:{kg700:{roll:[130,145,165],pass:[285,315,345]},kg900:{roll:[225,235,285],pass:[480,535,590]}},grass:{kg700:{roll:[165,185,215],pass:[320,355,395]},kg900:{roll:[315,360,410],pass:[570,640,715]}}},4000:{temps:{minus20:-13,isa:7,plus20:27},hard:{kg700:{roll:[175,195,220],pass:[375,415,460]},kg900:{roll:[305,345,390],pass:[645,720,800]}},grass:{kg700:{roll:[230,265,300],pass:[430,485,540]},kg900:{roll:[460,530,615],pass:[800,905,1025]}}},8000:{temps:{minus20:-21,isa:-1,plus20:19},hard:{kg700:{roll:[235,265,300],pass:[500,560,620]},kg900:{roll:[425,475,535],pass:[890,1000,1125]}},grass:{kg700:{roll:[330,380,440],pass:[595,675,760]},kg900:{roll:[700,820,960],pass:[1165,1350,1550]}}}};
  const LDG_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},moderate:{kg700:{roll:[145,155,165],pass:[365,385,400]},kg900:{roll:[185,200,210],pass:[435,460,485]}},nobrake_grass:{kg700:{roll:[215,230,250],pass:[435,460,485]},kg900:{roll:[280,300,325],pass:[530,560,590]} }},4000:{temps:{minus20:-13,isa:7,plus20:27},moderate:{kg700:{roll:[160,175,185],pass:[395,420,440]},kg900:{roll:[205,225,240],pass:[475,505,535]}},nobrake_grass:{kg700:{roll:[240,260,285],pass:[475,505,530]},kg900:{roll:[310,335,360],pass:[580,615,655]}}},8000:{temps:{minus20:-21,isa:-1,plus20:19},moderate:{kg700:{roll:[180,195,210],pass:[430,460,485]},kg900:{roll:[235,250,270],pass:[525,555,590]}},nobrake_grass:{kg700:{roll:[275,290,315],pass:[525,555,590]},kg900:{roll:[350,375,405],pass:[640,680,725]}}}};
  const DR300_TEMPS=[0,15,30,45];
  const TO_DR300 = {
    hard: { alts:[0,1500,3000,4500],
      roll: [[315,350,390,430],[330,360,400,460],[385,430,475,520],[430,480,520,560]],
      pass: [[530,590,655,720],[605,675,745,820],[685,765,845,920],[760,845,935,1020]],
    },
    grass: { alts:[0,1500,3000,4600],
      roll: [[380,420,470,515],[420,470,515,575],[455,510,570,625],[510,575,635,695]],
      pass: [[595,660,735,805],[675,745,820,895],[760,850,935,1025],[845,940,1040,1135]],
    },
    massScale: m => Math.min(1, m/1000)
  };

  /* ===================== UTILITAIRES ===================== */
  const $=s=>document.querySelector(s);
  const lerp=(x0,y0,x1,y1,x)=> y0 + (y1-y0)*((x-x0)/(x1-x0||1));
  const pad3=n=>String(Math.round(n)).padStart(3,'0');
  const clamp01=(v)=>Math.max(0,Math.min(1,v));

  /* ===================== OPTIONS AVION & UI ===================== */
  let landingMode='moderate', withSpats=true, profile='DR400', depSurface='hard';
  const propByAircraft={'F-GCAL (120cv)':'Sensenich','F-BXEK (120cv)':'Sensenich','F-BTKG (120cv)':'Sensenich','F-BTXS (120cv)':'Sensenich','F-BTBS (120cv)':'Mac Cauley','F-BTBJ (108cv)':'Mac Cauley'};
  $('#aircraftSel').addEventListener('change', ()=>{
    const ac=$('#aircraftSel').value;
    $('#propeller').value=propByAircraft[ac]||'';
    profile=(ac.startsWith('F-BTKG')||ac.startsWith('F-BTXS'))?'DR300':'DR400';
    updateWindDisplay('dep'); updateWindDisplay('arr');
  });
  // Carénages
  $('#spatsWith').onclick=()=>{withSpats=true;$('#spatsWith').classList.add('on');$('#spatsWithout').classList.remove('on');};
  $('#spatsWithout').onclick=()=>{withSpats=false;$('#spatsWithout').classList.add('on');$('#spatsWith').classList.remove('on');};
  // Surface départ
  $('#depSurfHard').onclick=()=>{depSurface='hard';$('#depSurfHard').classList.add('on');$('#depSurfGrass').classList.remove('on');};
  $('#depSurfGrass').onclick=()=>{depSurface='grass';$('#depSurfGrass').classList.add('on');$('#depSurfHard').classList.remove('on');};
  // Mode atterrissage
  $('#arrModerate').onclick=()=>{landingMode='moderate';$('#arrModerate').classList.add('on');$('#arrNoBrake').classList.remove('on');};
  $('#arrNoBrake').onclick=()=>{landingMode='nobrake_grass';$('#arrNoBrake').classList.add('on');$('#arrModerate').classList.remove('on');};

  function sanitizeIcao(el){el.value=(el.value||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,4)}
  ['depIcao','arrIcao'].forEach(id=>{ const el=$('#'+id); el.addEventListener('input',()=>sanitizeIcao(el)); el.addEventListener('blur',()=>sanitizeIcao(el)); });

  // QFU/LDA formats
  function normQFU(val){ let n=parseInt(String(val).replace(/\D/g,''),10); if(isNaN(n)) return null; n=Math.max(1,Math.min(360,n)); return n; }
  function display3(n){ return n===null?'':pad3(n); }
  ['depQfu','arrQfu'].forEach(id=>{
    const el=$('#'+id);
    el.addEventListener('blur',()=>{ const n=normQFU(el.value); el.value=display3(n); updateWindDisplay(id.startsWith('dep')?'dep':'arr'); });
    el.addEventListener('input',()=>{ updateWindDisplay(id.startsWith('dep')?'dep':'arr'); });
  });

  // TODA/LDA: pas de négatif, LDA max 4 chiffres (silencieux)
  $('#depToda').addEventListener('input',()=>{ let s=$('#depToda').value.replace(/\D/g,''); if(s==='') return; let v=parseInt(s,10); if(!isFinite(v)||v<0)v=0; $('#depToda').value=String(v); });
  $('#arrLda').addEventListener('input',()=>{ let s=$('#arrLda').value.replace(/\D/g,'').slice(0,4); $('#arrLda').value=s; });

  /* ===================== METAR (AVWX) ===================== */
  const AVWX_TOKEN='q45JCSdkFjeZqHUyvawV2iaFm80CYmlPP6kC3XS8VNs';
  async function fetchMetar(icao){
    if(!icao || icao.length!==4) throw new Error('ICAO invalide');
    const url=`https://avwx.rest/api/metar/${icao}`;
    const resp=await fetch(url,{ headers:{ Authorization:'Bearer '+AVWX_TOKEN, Accept:'application/json' }});
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    return await resp.json();
  }
  function parseSectorFromRaw(raw){ const m = raw && raw.match(/(\d{3})V(\d{3})/); return m ? {from:parseInt(m[1],10), to:parseInt(m[2],10)} : null; }
  function parseVarSector(data){
    const from=data?.variable_direction?.from, to=data?.variable_direction?.to;
    if(typeof from==='number' && typeof to==='number') return {from, to};
    return parseSectorFromRaw(data?.raw);
  }
  function applyMetar(side,data){
    const dirRepr=(data?.wind_direction?.repr ?? '');
    const dirVal =(data?.wind_direction?.value ?? null);
    const spdVal =Math.max(0,Math.round(data?.wind_speed?.value ?? 0));
    const gustVal=Math.max(0,Math.round(data?.wind_gust?.value ?? 0));
    const oatVal =Math.round(data?.temperature?.value ?? 15);
    const sector=parseVarSector(data);

    const dirEl=$('#'+side+'WindDir');
    if(dirRepr==='VRB'){dirEl.value='VRB';}
    else if(dirVal!==null){dirEl.value=pad3(dirVal);}

    $('#'+side+'WindKt').value=String(spdVal);
    $('#'+side+'WindGust').value=String(gustVal||0);
    $('#'+side+'Oat').value=String(oatVal);

    if(sector){
      $('#'+side+'VrbFrom').value=pad3(sector.from);
      $('#'+side+'VrbTo').value=pad3(sector.to);
    } else {
      $('#'+side+'VrbFrom').value=''; $('#'+side+'VrbTo').value='';
    }

    const msgEl = document.getElementById(side==='dep'?'depMetarMsg':'arrMetarMsg');
    msgEl.textContent = `METAR chargé : ${data?.raw || '—'}`;

    updateWindDisplay(side);
  }
  async function loadMetarFor(side){
    const icao=(($('#'+side+'Icao').value)||'').toUpperCase();
    const msgEl=document.getElementById(side==='dep'?'depMetarMsg':'arrMetarMsg');
    msgEl.textContent='Chargement METAR…';
    try{ const data=await fetchMetar(icao); applyMetar(side,data); }
    catch(e){ msgEl.textContent='METAR indisponible ('+(e.message||'erreur')+')'; }
  }
  document.getElementById('btnDepMetar').addEventListener('click',()=>loadMetarFor('dep'));
  document.getElementById('btnArrMetar').addEventListener('click',()=>loadMetarFor('arr'));

  /* ===================== AFFICHAGE COMPOSANTES (direct METAR) ===================== */
  function normAngleField(el){
    let v=el.value.trim(); if(!v){el.value='';return null;}
    let n=parseInt(v.replace(/\D/g,''),10);
    if(isNaN(n)){el.value='';return null;}
    n=Math.max(1,Math.min(360,n)); el.value=pad3(n); return n;
  }
  function dirForDisplay(dirField, sector){
    const t=(dirField||'').trim().toUpperCase();
    if(t==='VRB'){
      const f=normAngleField(document.getElementById(sector.fromId));
      const to=normAngleField(document.getElementById(sector.toId));
      if(!f || !to) return null;
      let a=f, b=to;
      let diff=((b-a+540)%360)-180;
      let mid=(a+diff/2+360)%360;
      if(mid===0) mid=360;
      return mid;
    }
    if(!t) return null;
    let n=parseInt(t.replace(/\D/g,''),10);
    if(isNaN(n)) return null;
    n=Math.max(1,Math.min(360,n));
    return n;
  }
  function cosd(d){return Math.cos(d*Math.PI/180)}
  function sind(d){return Math.sin(d*Math.PI/180)}
  function compsFrom(qfuDisp, dirDisp, kt){
    if(qfuDisp===null || dirDisp===null) return null;
    const q = (qfuDisp%360);
    const d = (dirDisp%360);
    const ang=Math.abs(((d - q + 540) % 360) - 180);
    const hwSigned = kt * cosd(ang);
    const xw = Math.abs(kt * sind(ang));
    return { face: Math.max(0, hwSigned), tail: Math.max(0, -hwSigned), xw };
  }

  function updateXwCardColor(side, xwVal){
    const card = document.getElementById(side+'XwCard');
    card.classList.remove('warn-yellow','warn-red');
    if(typeof xwVal==='number'){
      if(xwVal>=22){ card.classList.add('warn-red'); }
      else if(xwVal>=18){ card.classList.add('warn-yellow'); }
    }
  }

  function updateWindDisplay(side){
    const qfuIn=$('#'+side+'Qfu').value;
    const qfu = normQFU(qfuIn);
    const dirStr=$('#'+side+'WindDir').value||'';
    const kt=parseInt($('#'+side+'WindKt').value||'0',10)||0;
    const dirDisp = dirForDisplay(dirStr, {fromId:side+'VrbFrom', toId:side+'VrbTo'});

    if(qfu===null || dirDisp===null || !kt){
      $('#'+side+'HwFace').textContent='—';
      $('#'+side+'Xw').textContent='—';
      $('#'+side+'Tw').textContent='—';
      updateXwCardColor(side, null);
      if(side==='dep'){ $('#todaMini').textContent=$('#depToda').value?$('#depToda').value+' m':'—'; }
      else{ $('#ldaMini').textContent=($('#arrLda').value?$('#arrLda').value+' m':'—'); }
      return;
    }

    const c = compsFrom(qfu, dirDisp, kt);
    $('#'+side+'HwFace').textContent = Math.round(c.face);
    $('#'+side+'Xw').textContent    = Math.round(c.xw);
    $('#'+side+'Tw').textContent    = Math.round(c.tail);

    updateXwCardColor(side, c.xw);

    if(side==='dep'){ $('#todaMini').textContent=$('#depToda').value?$('#depToda').value+' m':'—'; }
    else{ $('#ldaMini').textContent=($('#arrLda').value?$('#arrLda').value+' m':'—'); }
  }

  ['depWindDir','arrWindDir','depWindKt','arrWindKt','depVrbFrom','arrVrbFrom','depVrbTo','arrVrbTo','depWindGust','arrWindGust','depOat','arrOat','depToda','arrLda']
  .forEach(id=>{
    $('#'+id).addEventListener('input',()=>updateWindDisplay(id.startsWith('dep')?'dep':'arr'));
    $('#'+id).addEventListener('blur',()=>{
      if(id.includes('Vrb')) normAngleField(document.getElementById(id));
      if(id.endsWith('WindDir')){
        const el=document.getElementById(id);
        const t=el.value.trim().toUpperCase();
        if(t && t!=='VRB'){ let n=parseInt(t.replace(/\D/g,''),10); if(!isNaN(n)){ n=Math.max(1,Math.min(360,n)); el.value=pad3(n);} }
      }
      updateWindDisplay(id.startsWith('dep')?'dep':'arr');
    });
  });

  /* ===================== RÈGLES “pire cas” POUR LES PERFS (secteur prioritaire s’il existe) ===================== */
  function worstWindForPerfAndLimit(qfuDisp, dirStr, kt, gust, sectorObj){
    const V=Math.max(0,kt|0), G=Math.max(V,gust|0);
    if(qfuDisp===null) return null;
    const q=(qfuDisp%360);
    function comps(dir, speed){
      const d = Math.abs(((dir-q+540)%360)-180);
      const hwSigned = speed * Math.cos(d*Math.PI/180);
      const xw = Math.abs(speed * Math.sin(d*Math.PI/180));
      return {d, hwSigned, xw, dir};
    }
    const t=(dirStr||'').trim().toUpperCase();
    const f=normQFU($('#'+sectorObj.fromId).value), to=normQFU($('#'+sectorObj.toId).value);
    const hasSector=!!(f&&to);
    function sectorDirs(){
      if(!hasSector) return [];
      let a=f%360,b=to%360;
      const diff=((b-a+540)%360)-180;
      const mid=(a+diff/2+360)%360;
      return [a,b,mid];
    }

    // 1) S’il y a un SECTEUR rempli, on l’utilise TOUJOURS (même si la direction n’est pas “VRB”)
    if(hasSector){
      const dirs=sectorDirs();
      const passesTail = dirs.some(d=> Math.abs(((d-q+540)%360)-180) > 90);
      if(passesTail){
        // Cas avec composante arrière possible → vitesse max/rafale
        let worst = {hwSigned:+1e9, dir:null};
        dirs.forEach(d=>{ const c=comps(d,G); if(c.hwSigned<worst.hwSigned){ worst=c; }});
        return { headwindForFactor:worst.hwSigned, explain:`Secteur ${pad3(f)}V${pad3(to)} : passage à l'arrière → rafale/max (${G} kt) au cap ${pad3(worst.dir)}°` };
      }else{
        // Pas d’arrière : prendre le bord le plus défavorable (le plus de travers / moins de face) avec vitesse minimale
        let edge=null;
        dirs.forEach(d=>{ const c=comps(d,V); if(!edge || c.hwSigned<edge.hwSigned){ edge=c; }});
        return { headwindForFactor:edge.hwSigned, explain:`Secteur ${pad3(f)}V${pad3(to)} : pas d’arrière → bord le plus défavorable (${pad3(edge.dir)}°) avec vitesse minimale (${V} kt)` };
      }
    }

    // 2) Sinon, appliquer la règle standard “VRB sans secteur” ou direction fixe
    if(t==='VRB'){
      const cTail = comps((q+180)%360, G);
      return { headwindForFactor:cTail.hwSigned, explain:`VRB sans secteur → cas arrière à 180° avec vitesse max/rafale (${G} kt)` };
    }
    let n=parseInt(t.replace(/\D/g,''),10);
    if(!isNaN(n)){
      n=Math.max(1,Math.min(360,n));
      const ang=Math.abs(((n-q+540)%360)-180);
      const useG = ang>90; // >90° → composante arrière → on prend la rafale
      const spd = useG ? G : V;
      const c=comps(n, spd);
      return { headwindForFactor:c.hwSigned, explain:`Vent ${pad3(n)}° ${spd} kt (${useG?'rafale/max car composante arrière possible':'vitesse moyenne car face/travers'})` };
    }
    return { headwindForFactor:0, explain:`Vent non interprétable → facteur vent neutre` };
  }

  /* ===================== INTERPOLATIONS ===================== */
  function interpTemp(rowTemps,arr,oat){
    const xs=[rowTemps.minus20,rowTemps.isa,rowTemps.plus20],ys=arr;
    if(oat<=xs[0])return ys[0]; if(oat>=xs[2])return ys[2];
    if(oat<=xs[1])return lerp(xs[0],ys[0],xs[1],ys[1],oat);
    return lerp(xs[1],ys[1],xs[2],ys[2],oat);
  }
  function interpTO_DR400(altFt,oat,massKg,surface,kind){
    const low=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    const high=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    const alpha=clamp01((massKg-700)/(900-700));
    const valAt=alt=>{const t=TO_DR400[alt]; const v700=interpTemp(t.temps,t[surface].kg700[kind],oat); const v900=interpTemp(t.temps,t[surface].kg900[kind],oat); return lerp(0,v700,1,v900,alpha);};
    if(low===high)return valAt(low); return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function interpLDG_DR400(altFt,oat,massKg,mode,kind){
    const low=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    const high=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    const alpha=clamp01((massKg-700)/(900-700));
    const valAt=alt=>{const t=LDG_DR400[alt]; const v700=interpTemp(t.temps,t[mode].kg700[kind],oat); const v900=interpTemp(t.temps,t[mode].kg900[kind],oat); return lerp(0,v700,1,v900,alpha);};
    if(low===high)return valAt(low); return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function interpGridDR300(surface,kind,altFt,oat,massKg){
    const surf=TO_DR300[surface], temps=DR300_TEMPS, alts=surf.alts;
    function interpRow(row){const ys=row,x=oat;
      if(x<=temps[0])return ys[0]; if(x>=temps[3])return ys[3];
      if(x<=temps[1])return lerp(temps[0],ys[0],temps[1],ys[1],x);
      if(x<=temps[2])return lerp(temps[1],ys[1],temps[2],ys[2],x);
      return lerp(temps[2],ys[2],temps[3],ys[3],x);
    }
    let a0=alts[0], a1=alts[alts.length-1];
    for(let i=0;i<alts.length-1;i++){
      if(altFt<=alts[0]){a0=a1=alts[0];break;}
      if(altFt>=alts[alts.length-1]){a0=a1=alts[alts.length-1];break;}
      if(altFt>=alts[i] && altFt<=alts[i+1]){a0=alts[i];a1=alts[i+1];break;}
    }
    const idx0=alts.indexOf(a0), idx1=alts.indexOf(a1);
    const v0=interpRow(surf[kind][idx0]);
    const v1=interpRow(surf[kind][idx1]);
    let val=(a0===a1)?v0:lerp(a0,v0,a1,v1,altFt);
    return val*TO_DR300.massScale(massKg);
  }

  /* ===================== FACTEUR VENT PERFS ===================== */
  function windDistanceFactor(head){
    if(head>=0){
      const pts=[{x:0,y:1.00},{x:10,y:0.78},{x:20,y:0.63},{x:30,y:0.52}],x=Math.max(0,Math.min(30,head));
      if(x===0)return 1;
      for(let i=0;i<pts.length-1;i++){const p0=pts[i],p1=pts[i+1];if(x>=p0.x&&x<=p1.x)return p0.y+(p1.y-p0.y)*((x-p0.x)/(p1.x-p0.x))}
      return pts.at(-1).y;
    }else{
      const tw=Math.abs(head),steps=Math.ceil(tw/2);
      return 1+0.10*steps;
    }
  }

  /* ===================== CALCUL BOUTONS ===================== */
  function readWorst(side){
    const qfu=normQFU($('#'+side+'Qfu').value);
    const df=$('#'+side+'WindDir').value;
    const kt=parseInt($('#'+side+'WindKt').value||'0',10)||0;
    const gust=parseInt($('#'+side+'WindGust').value||'0',10)||0;
    return worstWindForPerfAndLimit(qfu, df, kt, gust, {fromId:side+'VrbFrom', toId:side+'VrbTo'});
  }

  function setChip(el,state){el.className='chip '+(state==='ok'?'ok':state==='bad'?'bad':'neutral');el.textContent=state==='ok'?'OK':'KO'}

  function computeDepPerf(){
    const qfu=normQFU($('#depQfu').value);
    if(qfu===null){
      setChip($('#toChip'),'neutral'); $('#toKpi').className='kpi';
      ['toBasePass','toBaseRoll','toWindF','toSpat','toExtra','toRes'].forEach(id=>$('#'+id).textContent='—');
      $('#toExplain').textContent='';
      return;
    }
    const depAlt=+($('#depAlt')?.value||0), depOat=+($('#depOat').value||0),
          depExtra=+($('#depExtraTO').value||1), depTow=+($('#depTow').value||900),
          depToda=+($('#depToda').value||0), safety=+($('#safety').value||30);
    const w=readWorst('dep');

    let baseTO_pass, baseTO_roll;
    if(profile==='DR300'){
      baseTO_pass=interpGridDR300(depSurface,'pass',depAlt,depOat,depTow);
      baseTO_roll=interpGridDR300(depSurface,'roll',depAlt,depOat,depTow);
    }else{
      baseTO_pass=interpTO_DR400(depAlt,depOat,depTow,depSurface,'pass');
      baseTO_roll=interpTO_DR400(depAlt,depOat,depTow,depSurface,'roll');
    }

    const depWindF=windDistanceFactor(w.headwindForFactor||0);
    const spatsF=withSpats?1.00:1.03;
    const toCalc=Math.round(baseTO_pass*depWindF*depExtra*spatsF);
    const toMargin=Math.round(toCalc*(1+safety/100));

    $('#toBasePass').textContent=Math.round(baseTO_pass)+' m';
    $('#toBaseRoll').textContent=Math.round(baseTO_roll)+' m';
    $('#toWindF').textContent=depWindF.toFixed(2)+'×';
    $('#toSpat').textContent=`${spatsF.toFixed(2)}×`+(spatsF===1?' (carénages présents)':' (sans carénages)');
    $('#toExtra').textContent=depExtra.toFixed(2)+'×';
    $('#toRes').textContent=toCalc+' m';
    $('#todaMini').textContent=$('#depToda').value?$('#depToda').value+' m':'—';

    const stTO=(depToda? (toMargin<=depToda?'ok':'bad'):'neutral');
    setChip($('#toChip'),stTO); $('#toKpi').className='kpi '+(stTO==='ok'?'ok':stTO==='bad'?'bad':'');
    $('#toKpiVal').textContent=toMargin+' m';

    $('#toExplain').textContent = `Règle vent : ${w.explain || '—'}. Facteur vent = ${depWindF.toFixed(2)}× (composante utilisée ${Math.round(w.headwindForFactor||0)} kt). Surface=${depSurface==='hard'?'Dur':'Herbe'} · Spats=${withSpats?'Avec':'Sans'}.`;
  }

  function computeArrPerf(){
    const qfu=normQFU($('#arrQfu').value);
    if(qfu===null){
      setChip($('#ldgChip'),'neutral'); $('#ldgKpi').className='kpi';
      ['ldgBasePass','ldgBaseRoll','ldgWindF','ldgExtra','ldgRes'].forEach(id=>$('#'+id).textContent='—');
      $('#ldgExplain').textContent='';
      return;
    }
    const arrAlt=+($('#arrAlt').value||0), arrOat=+($('#arrOat').value||0),
          arrExtra=+($('#arrExtraLDG').value||1), arrLdw=+($('#arrLdw').value||900),
          arrLda=+($('#arrLda').value||0), safety=+($('#safety').value||30);
    const w=readWorst('arr');

    const baseLDG_pass=interpLDG_DR400(arrAlt,arrOat,arrLdw,landingMode,'pass');
    const baseLDG_roll=interpLDG_DR400(arrAlt,arrOat,arrLdw,landingMode,'roll');
    const arrWindF=windDistanceFactor(w.headwindForFactor||0);
    const ldgCalc=Math.round(baseLDG_pass*arrWindF*arrExtra);
    const ldgMargin=Math.round(ldgCalc*(1+safety/100));

    $('#ldgBasePass').textContent=Math.round(baseLDG_pass)+' m';
    $('#ldgBaseRoll').textContent=Math.round(baseLDG_roll)+' m';
    $('#ldgWindF').textContent=arrWindF.toFixed(2)+'×';
    $('#ldgExtra').textContent=arrExtra.toFixed(2)+'×';
    $('#ldgRes').textContent=ldgCalc+' m';
    $('#ldaMini').textContent=$('#arrLda').value?$('#arrLda').value+' m':'—';

    const stLDG=(arrLda? (ldgMargin<=arrLda?'ok':'bad'):'neutral');
    setChip($('#ldgChip'),stLDG); $('#ldgKpi').className='kpi '+(stLDG==='ok'?'ok':stLDG==='bad'?'bad':'');
    $('#ldgKpiVal').textContent=ldgMargin+' m';

    $('#ldgExplain').textContent = `Règle vent : ${w.explain || '—'}. Facteur vent = ${arrWindF.toFixed(2)}× (composante utilisée ${Math.round(w.headwindForFactor||0)} kt). Type de freinage=${landingMode==='moderate'?'Freinage modéré':'Sans frein herbe'}.`;
  }

  document.getElementById('btnCalcDep').addEventListener('click', computeDepPerf);
  document.getElementById('btnCalcArr').addEventListener('click', computeArrPerf);

  /* ===================== IMPRESSION ===================== */
  function buildRawReport(){
    const safety=+($('#safety').value||30);
    const aircraft=$('#aircraftSel').value;
    const prop=$('#propeller').value;
    const spats=$('#spatsWith').classList.contains('on')?'Avec carénages':'Sans carénages (+3% TO)';

    const D={ icao:($('#depIcao').value||'').toUpperCase(), qfu:+($('#depQfu').value||0), toda:+($('#depToda').value||0),
              alt:+($('#depAlt')?.value||0), oat:+($('#depOat').value||0),
              wdir:($('#depWindDir').value||'').toUpperCase(), wkt:+($('#depWindKt').value||0) };
    const A={ icao:($('#arrIcao').value||'').toUpperCase(), qfu:+($('#arrQfu').value||0), lda:+($('#arrLda').value||0),
              alt:+($('#arrAlt').value||0), oat:+($('#arrOat').value||0),
              wdir:($('#arrWindDir').value||'').toUpperCase(), wkt:+($('#arrWindKt').value||0) };

    const ts=new Date().toLocaleString('fr-FR');

    return [
      `CALCULCATEUR DE PERFORMANCES`,
      `Horodatage : ${ts}`,
      ``,
      `[Paramètres généraux]`,
      `  Avion : ${aircraft}    Hélice : ${prop}    Profil : ${profile}`,
      `  Marge sécurité : ${safety}%`,
      `  Carénages : ${spats}`,
      ``,
      `[Départ]`,
      `  ICAO : ${D.icao}    QFU : ${pad3(D.qfu||0)}°`,
      `  Élévation : ${D.alt} ft    OAT : ${D.oat} °C`,
      `  Vent : ${D.wdir}/${Math.round(D.wkt)} kt`,
      ``,
      `[Arrivée]`,
      `  ICAO : ${A.icao}    QFU : ${pad3(A.qfu||0)}°`,
      `  Élévation : ${A.alt} ft    OAT : ${A.oat} °C`,
      `  Vent : ${A.wdir}/${Math.round(A.wkt)} kt`,
      ``,
      `Source : Manuel de vol respectif de chaque avion - Aéroclub de Beauvais-Tillé`,
      `Développé par Hugo DERUELLE avec l'aide de l'IA`,
    ].join('\n');
  }
  window.addEventListener('beforeprint', ()=>{document.getElementById('rawPre').textContent = buildRawReport();});

  // Init
  (function init(){ const ac=$('#aircraftSel').value; $('#propeller').value=propByAircraft[ac]||''; updateWindDisplay('dep'); updateWindDisplay('arr'); })();
</script>
</body>
</html>
