<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DR400-120 – Calculateur de performances</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#6b7280;
      --ok:#16a34a;--bad:#dc2626;--line:#e5e7eb;--primary:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial}
    h1{font-size:clamp(20px,3vw,28px);margin:0}
    h2{font-size:18px;margin:0 0 .6rem 0}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1200px){.row{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .btn{border:1px solid var(--line);background:#fff;padding:9px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.toggle.on{background:var(--primary);color:#fff;border-color:var(--primary)}
    label{display:block;font-size:12px;color:var(--muted)}
    input,select{width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .grid1{display:grid;grid-template-columns:1fr;gap:12px}
    .field{border:1px solid var(--line);border-radius:12px;background:#f8fafc;padding:10px}
    .field .k{font-size:12px;color:var(--muted)}
    .field .v{margin-top:4px;font-weight:600}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .footer{font-size:12px;color:var(--muted);margin-top:18px}
    .hidden{display:none}

    /* KPI binaire OK/KO */
    .kpi{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:16px;padding:14px 16px;margin:8px 0}
    .kpi .left{display:flex;flex-direction:column}
    .kpi .title{font-size:12px;color:var(--muted);letter-spacing:.02em}
    .kpi .value{font-size:26px;font-weight:800;line-height:1.1}
    .kpi .sub{font-size:12px;color:var(--muted)}
    .kpi.ok{background:#ecfdf5;border-color:#86efac}
    .kpi.bad{background:#fef2f2;border-color:#fecaca}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid;font-weight:800}
    .chip.ok{background:#dcfce7;color:#14532d;border-color:#86efac}
    .chip.bad{background:#fee2e2;color:#7f1d1d;border-color:#fca5a5}
    .chip.neutral{background:#f3f4f6;color:#374151;border-color:#e5e7eb}

    @media print{
      .no-print{display:none !important}
      body{background:#fff}
      .container{max-width:none;padding:0}
      .card{box-shadow:none}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>DR400-120 · Calculateur de performances</h1>
    <div class="no-print" style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="importCsvBtn" class="btn">Importer CSV terrains</button>
      <input id="csvInput" type="file" accept=".csv" class="hidden" />
      <button class="btn primary" onclick="window.print()">Imprimer</button>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <!-- Terrain / Piste -->
    <section class="card">
      <h2>Terrain / Piste</h2>

      <!-- Sélecteurs FR (OurAirports) -->
      <div class="grid3">
        <label>Aérodrome [FR]
          <select id="frAirport"></select>
        </label>
        <label>Piste
          <select id="frRunway"></select>
        </label>
        <label>Intersection (m depuis seuil)
          <input id="intersection" type="number" value="0"/>
        </label>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>ICAO
          <input id="icao" />
        </label>
        <label>QFU (°)
          <input id="qfu" type="number" value="0"/>
        </label>
        <label>TODA (m)
          <input id="toda" type="number" value="0"/>
        </label>
        <label>LDA (m)
          <input id="lda" type="number" value="0"/>
        </label>
        <div class="grid1">
          <label>Surface piste</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="surfHard" class="btn toggle on">Dur</button>
            <button id="surfGrass" class="btn toggle">Herbe</button>
          </div>
        </div>
        <div class="grid1">
          <label>Carénages de roues</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="spatsWith" class="btn toggle on">Avec carénages de roues</button>
            <button id="spatsWithout" class="btn toggle">Sans carénages de roues</button>
          </div>
        </div>
      </div>
      <div class="muted" id="frInfo" style="margin-top:6px">Chargement des terrains FR…</div>
    </section>

    <!-- Conditions -->
    <section class="card">
      <h2>Conditions</h2>
      <div class="grid2">
        <label>Élévation (ft)
          <input id="alt" type="number" value="0"/>
        </label>
        <label>OAT (°C)
          <input id="oat" type="number" value="15"/>
        </label>
        <label>Vent — Direction (°)
          <input id="windDir" type="number" value="0"/>
        </label>
        <label>Vent — Vitesse (kt)
          <input id="windKt" type="number" value="0"/>
        </label>
      </div>

      <!-- Composantes vent séparées -->
      <div class="grid3" style="margin-top:10px">
        <div class="field"><div class="k">Vent de face</div><div class="v"><span id="hwFaceText">0</span> kt</div></div>
        <div class="field"><div class="k">Vent de travers</div><div class="v"><span id="xwText">0</span> kt</div></div>
        <div class="field"><div class="k">Vent arrière</div><div class="v"><span id="twText">0</span> kt</div></div>
      </div>
      <div class="muted" id="xwWarn" style="margin-top:6px"></div>

      <div class="grid2" style="margin-top:10px">
        <label>Facteur suppl. décollage
          <input id="extraTO" type="number" step="0.01" value="1.00"/>
        </label>
        <label>Facteur suppl. atterrissage
          <input id="extraLDG" type="number" step="0.01" value="1.00"/>
        </label>
        <label>Marge sécurité (%)
          <input id="safety" type="number" value="30"/>
        </label>
      </div>

      <!-- ISA & ΔISA -->
      <div class="grid2" style="margin-top:10px">
        <div class="field"><div class="k">ISA théorique (°C)</div><div class="v" id="isaText">15.0 °C</div></div>
        <div class="field"><div class="k">ΔISA = OAT − ISA</div><div class="v" id="deltaIsaText">0.0 °C</div></div>
      </div>
      <div class="muted" style="margin-top:6px">
        L’ISA sert de référence perf/instruments. Au niveau de la mer : 15 °C, 1013,25 hPa.
        Sous la tropopause (~11 km), la température baisse d’environ 6,5 °C/1000 m ≈ 2 °C/1000 ft.
        Formule : ISA [°C] = 15 − (2 × altitude [ft] / 1000). ΔISA [°C] = OAT − ISA.
      </div>
    </section>

    <!-- Masses -->
    <section class="card">
      <h2>Masses & Atterrissage</h2>
      <div class="grid2">
        <label>Masse décollage (kg)
          <input id="tow" type="number" value="900"/>
        </label>
        <label>Masse atterrissage (kg)
          <input id="ldw" type="number" value="900"/>
        </label>
      </div>
      <div style="margin-top:10px">
        <label>Atterrissage — mode</label>
        <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
          <button id="ldgModerate" class="btn toggle on">Freinage modéré (dur/herbe)</button>
          <button id="ldgNoBrake" class="btn toggle">Sans frein sur herbe</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Résultats -->
  <section class="row" style="margin-top:16px">
    <div class="card">
      <div class="header">
        <h2>Décollage (15 m)</h2>
        <span id="toChip" class="chip neutral">—</span>
      </div>
      <div id="toKpi" class="kpi">
        <div class="left">
          <span class="title">Requis (marge incluse)</span>
          <span class="value" id="toKpiVal">— m</span>
          <span class="sub">TODA dispo : <span id="todaMini">—</span></span>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="field"><div class="k">Base (passage 15 m)</div><div id="toBasePass" class="v">—</div></div>
        <div class="field"><div class="k">Roulement (info)</div><div id="toBaseRoll" class="v">—</div></div>
        <div class="field"><div class="k">Facteur vent</div><div id="toWindF" class="v">—</div></div>
        <div class="field"><div class="k">Carénages</div><div id="toSpat" class="v">—</div></div>
        <div class="field"><div class="k">Facteur supplémentaire</div><div id="toExtra" class="v">—</div></div>
        <div class="field"><div class="k">Résultat (sans marge)</div><div id="toRes" class="v">—</div></div>
        <div class="field"><div class="k">+ Marge</div><div id="toResM" class="v">—</div></div>
      </div>
    </div>

    <div class="card">
      <div class="header">
        <h2>Atterrissage (15 m → arrêt)</h2>
        <span id="ldgChip" class="chip neutral">—</span>
      </div>
      <div id="ldgKpi" class="kpi">
        <div class="left">
          <span class="title">Requis (marge incluse)</span>
          <span class="value" id="ldgKpiVal">— m</span>
          <span class="sub">LDA dispo : <span id="ldaMini">—</span></span>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="field"><div class="k">Base (passage 15 m)</div><div id="ldgBasePass" class="v">—</div></div>
        <div class="field"><div class="k">Roulement (info)</div><div id="ldgBaseRoll" class="v">—</div></div>
        <div class="field"><div class="k">Facteur vent</div><div id="ldgWindF" class="v">—</div></div>
        <div class="field"><div class="k">Facteur supplémentaire</div><div id="ldgExtra" class="v">—</div></div>
        <div class="field"><div class="k">Résultat (sans marge)</div><div id="ldgRes" class="v">—</div></div>
        <div class="field"><div class="k">+ Marge</div><div id="ldgResM" class="v">—</div></div>
      </div>
    </div>
  </section>

  <div class="footer">
    Sources : Manuel de vol DR400-120 (tables perf. – STD±20). Facteurs vent : face (10→0,78 ; 20→0,63 ; 30→0,52) · arrière : +10 %/2 kt. Bulletin ROBIN « Sans carénages » : +3 % sur décollage (15 m). Données terrains : OurAirports (airports.csv, runways.csv) — France.
  </div>
</div>

<script>
  /*=================== Tables 1979 — Décollage (STD±20) ===================*/
  const TO_TABLE = {
    0: {
      temps:{minus20:-5, isa:15, plus20:35},
      hard:{ kg700:{roll:[130,145,165], pass:[285,315,345]},
             kg900:{roll:[225,235,285], pass:[480,535,590]} },
      grass:{kg700:{roll:[165,185,215], pass:[320,355,395]},
             kg900:{roll:[315,360,410], pass:[570,640,715]} }
    },
    4000: {
      temps:{minus20:-13, isa:7, plus20:27},
      hard:{ kg700:{roll:[175,195,220], pass:[375,415,460]},
             kg900:{roll:[305,345,390], pass:[645,720,800]} },
      grass:{kg700:{roll:[230,265,300], pass:[430,485,540]},
             kg900:{roll:[460,530,615], pass:[800,905,1025]} }
    },
    8000: {
      temps:{minus20:-21, isa:-1, plus20:19},
      hard:{ kg700:{roll:[235,265,300], pass:[500,560,620]},
             kg900:{roll:[425,475,535], pass:[890,1000,1125]} },
      grass:{kg700:{roll:[330,380,440], pass:[595,675,760]},
             kg900:{roll:[700,820,960], pass:[1165,1350,1550]} }
    }
  };

  /*=================== Tables 1979 — Atterrissage (STD±20) ===================*/
  const LDG_TABLE = {
    0: {
      temps:{minus20:-5, isa:15, plus20:35},
      moderate:{ kg700:{roll:[145,155,165], pass:[365,385,400]},
                 kg900:{roll:[185,200,210], pass:[435,460,485]} },
      nobrake_grass:{ kg700:{roll:[215,230,250], pass:[435,460,485]},
                       kg900:{roll:[280,300,325], pass:[530,560,590]} }
    },
    4000: {
      temps:{minus20:-13, isa:7, plus20:27},
      moderate:{ kg700:{roll:[160,175,185], pass:[395,420,440]},
                 kg900:{roll:[205,225,240], pass:[475,505,535]} },
      nobrake_grass:{ kg700:{roll:[240,260,285], pass:[475,505,530]},
                       kg900:{roll:[310,335,360], pass:[580,615,655]} }
    },
    8000: {
      temps:{minus20:-21, isa:-1, plus20:19},
      moderate:{ kg700:{roll:[180,195,210], pass:[430,460,485]},
                 kg900:{roll:[235,250,270], pass:[525,555,590]} },
      nobrake_grass:{ kg700:{roll:[275,290,315], pass:[525,555,590]},
                       kg900:{roll:[350,375,405], pass:[640,680,725]} }
    }
  };

  /*=================== Utils ===================*/
  const $ = s => document.querySelector(s);
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const lerp = (x0,y0,x1,y1,x)=> y0 + (y1-y0)*((x-x0)/(x1-x0||1));
  const isaAt = altFt => 15 - 2*(altFt/1000);

  function interpTemp(rowTemps, arr, oat){
    const xs=[rowTemps.minus20,rowTemps.isa,rowTemps.plus20], ys=arr;
    if(oat<=xs[0]) return ys[0];
    if(oat>=xs[2]) return ys[2];
    if(oat<=xs[1]) return lerp(xs[0],ys[0],xs[1],ys[1],oat);
    return lerp(xs[1],ys[1],xs[2],ys[2],oat);
  }
  function interpTO(altFt,oat,massKg,surface,kind){ // 'roll'|'pass'
    const low = altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    const high= altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    const alpha = clamp((massKg-700)/(900-700),0,1);
    const valAt = (alt)=>{
      const t=TO_TABLE[alt];
      const v700 = interpTemp(t.temps, t[surface].kg700[kind], oat);
      const v900 = interpTemp(t.temps, t[surface].kg900[kind], oat);
      return lerp(0,v700,1,v900,alpha);
    };
    if(low===high) return valAt(low);
    return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function interpLDG(altFt,oat,massKg,mode,kind){
    const low = altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    const high= altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    const alpha = clamp((massKg-700)/(900-700),0,1);
    const valAt = (alt)=>{
      const t=LDG_TABLE[alt];
      const v700 = interpTemp(t.temps, t[mode].kg700[kind], oat);
      const v900 = interpTemp(t.temps, t[mode].kg900[kind], oat);
      return lerp(0,v700,1,v900,alpha);
    };
    if(low===high) return valAt(low);
    return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function windComponents(qfu, windDir, windKt){
    const diff = ((windDir - qfu + 540) % 360) - 180;
    const rad = diff * Math.PI/180;
    return { headwind: windKt*Math.cos(rad), crosswind: windKt*Math.sin(rad) };
  }
  // Face (interpolation), arrière (+10 % / 2 kt)
  function headwindFactorFace(hw){
    const pts=[{x:0,y:1.00},{x:10,y:0.78},{x:20,y:0.63},{x:30,y:0.52}];
    const x=clamp(hw,0,30);
    if(x===0) return 1;
    for(let i=0;i<pts.length-1;i++){
      const p0=pts[i], p1=pts[i+1];
      if(x>=p0.x && x<=p1.x) return lerp(p0.x,p0.y,p1.x,p1.y,x);
    }
    return pts.at(-1).y;
  }
  function windDistanceFactor(headwind){
    if(headwind>=0) return headwindFactorFace(headwind);
    const tw = Math.abs(headwind);
    const steps = Math.ceil(tw/2);
    return 1 + 0.10*steps;
  }
  function setChip(el, state){
    el.className='chip '+(state==='ok'?'ok':state==='bad'?'bad':'neutral');
    el.textContent = state==='ok'?'OK':state==='bad'?'KO':'—';
  }
  function setKpi(el, state){
    el.className='kpi '+(state==='ok'?'ok':state==='bad'?'bad':'');
  }
  function status(val,limit){
    if(!limit) return 'neutral';
    return val<=limit ? 'ok' : 'bad';
  }

  /*=================== État & UI ===================*/
  let surface='hard';
  let landingMode='moderate';
  let withSpats = true; // carénages présents par défaut

  // Distances auto (OurAirports)
  let autoTODA = 0, autoLDA = 0, selLenM=0;

  ['qfu','toda','lda','alt','oat','windDir','windKt','extraTO','extraLDG','safety','tow','ldw','icao','intersection']
    .forEach(id=>$('#'+id).addEventListener('input', compute));

  // Surface
  $('#surfHard').onclick=()=>{surface='hard';$('#surfHard').classList.add('on');$('#surfGrass').classList.remove('on');compute()};
  $('#surfGrass').onclick=()=>{surface='grass';$('#surfGrass').classList.add('on');$('#surfHard').classList.remove('on');compute()};

  // Carénages (2 boutons)
  $('#spatsWith').onclick=()=>{withSpats=true;$('#spatsWith').classList.add('on');$('#spatsWithout').classList.remove('on');compute()};
  $('#spatsWithout').onclick=()=>{withSpats=false;$('#spatsWithout').classList.add('on');$('#spatsWith').classList.remove('on');compute()};

  // Atterrissage mode
  $('#ldgModerate').onclick=()=>{landingMode='moderate';$('#ldgModerate').classList.add('on');$('#ldgNoBrake').classList.remove('on');compute()};
  $('#ldgNoBrake').onclick=()=>{landingMode='nobrake_grass';$('#ldgNoBrake').classList.add('on');$('#ldgModerate').classList.remove('on');compute()};

  // Import CSV manuel
  const csvBtn = $('#importCsvBtn'), csvInput=$('#csvInput');
  csvBtn.onclick = ()=>csvInput.click();
  csvInput.onchange = e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{ parseCSV(String(r.result)); alert('CSV chargé. Utilise ICAO/QFU/TODA/LDA.'); }
      catch(err){ alert('CSV invalide'); }
    };
    r.readAsText(f);
  };
  function parseCSV(text){ /* simple parse */ return text.split('\n'); }

  /*=================== OurAirports [FR] ===================*/
  const frAirportSel = $('#frAirport');
  const frRunwaySel = $('#frRunway');
  const frInfo = $('#frInfo');

  let byIcao = new Map();

  async function loadOurAirportsFR(){
    try{
      const [aTxt, rTxt] = await Promise.all([
        fetch('https://ourairports.com/data/airports.csv').then(r=>r.text()),
        fetch('https://ourairports.com/data/runways.csv').then(r=>r.text()),
      ]);
      const A = csvToObjs(aTxt);
      const R = csvToObjs(rTxt);
      const airports = A.filter(x=>x.iso_country==='FR' && ['small_airport','medium_airport','large_airport'].includes(x.type));
      byIcao.clear();
      airports.forEach(ap=>{
        const icao = ap.ident;
        if(!icao || icao.length!==4) return;
        const rws = R.filter(r=>r.airport_ident===icao);
        const ends = [];
        rws.forEach(r=>{
          const len_m = Math.round((Number(r.length_ft)||0)*0.3048);
          if(r.le_ident){
            ends.push({end:String(r.le_ident), qfu:Number(r.le_heading_degT)|| (parseInt(r.le_ident,10)*10 || 0),
              surface:String(r.surface||'').toUpperCase(), len_m,
              disp_m:Math.round((Number(r.le_displaced_threshold_ft)||0)*0.3048), side:'le'});
          }
          if(r.he_ident){
            ends.push({end:String(r.he_ident), qfu:Number(r.he_heading_degT)|| (parseInt(r.he_ident,10)*10 || 0),
              surface:String(r.surface||'').toUpperCase(), len_m,
              disp_m:Math.round((Number(r.he_displaced_threshold_ft)||0)*0.3048), side:'he'});
          }
        });
        if(ends.length) byIcao.set(icao, {name:ap.name, ends});
      });
      // Populate selects
      frAirportSel.innerHTML='';
      [...byIcao.entries()].sort((a,b)=> a[0].localeCompare(b[0])).forEach(([icao,info])=>{
        const opt=document.createElement('option'); opt.value=icao; opt.textContent=`${icao} — ${info.name}`; frAirportSel.appendChild(opt);
      });
      frInfo.textContent = `Bases FR chargées (${byIcao.size} terrains).`;
      if(byIcao.size){ frAirportSel.value=[...byIcao.keys()][0]; onSelectAirport(); }
    }catch(e){
      frInfo.textContent = 'Chargement OurAirports échoué. Tu peux saisir/CSV manu.';
    }
  }
  function csvToObjs(text){
    const [head,...rows]=text.split(/\r?\n/).filter(Boolean);
    const cols=head.split(',').map(s=>s.trim());
    return rows.map(r=>{
      const vals=parseCSVLine(r);
      const o={}; cols.forEach((c,i)=>o[c]=vals[i]); return o;
    });
  }
  function parseCSVLine(line){
    // basique (guillemets non imbriqués)
    const out=[]; let cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='\"'){ inQ=!inQ; continue;}
      if(ch===',' && !inQ){ out.push(cur); cur=''; continue;}
      cur+=ch;
    }
    out.push(cur); return out.map(s=>s.trim());
  }

  function onSelectAirport(){
    const icao = frAirportSel.value;
    const info = byIcao.get(icao);
    frRunwaySel.innerHTML='';
    if(!info){ compute(); return; }
    info.ends.forEach((rw,idx)=>{
      const surf = rw.surface.includes('GRASS')?'Herbe':'Dur';
      const opt=document.createElement('option');
      opt.value=String(idx);
      opt.textContent = `${rw.end} · QFU ${rw.qfu}° · ${surf} · ${rw.len_m} m`;
      frRunwaySel.appendChild(opt);
    });
    frRunwaySel.value='0';
    onSelectRunway();
  }

  function onSelectRunway(){
    const icao = frAirportSel.value;
    const info = byIcao.get(icao);
    const rw = info?.ends[Number(frRunwaySel.value)];
    if(!rw){ compute(); return; }
    $('#icao').value = icao;
    $('#qfu').value = rw.qfu;
    selLenM = rw.len_m;

    // Surface toggle
    if(rw.surface.includes('GRASS')) $('#surfGrass').click(); else $('#surfHard').click();

    // Intersection
    const inter = Number($('#intersection').value||0);
    const interClamped = Math.max(0, Math.min(inter, rw.len_m));
    if(inter !== interClamped){ $('#intersection').value = String(interClamped); }

    // TODA/LDA approx si non saisis
    autoTODA = Math.max(0, rw.len_m - interClamped);
    autoLDA  = Math.max(0, (rw.len_m - rw.disp_m) - interClamped);

    const tVal = Number($('#toda').value||0);
    const lVal = Number($('#lda').value||0);
    if(!tVal) $('#toda').value = String(autoTODA);
    if(!lVal) $('#lda').value  = String(autoLDA);

    compute();
  }

  frAirportSel.addEventListener('change', onSelectAirport);
  frRunwaySel.addEventListener('change', onSelectRunway);
  $('#intersection').addEventListener('input', onSelectRunway);

  /*=================== Calculs ===================*/
  function compute(){
    const qfu = Number($('#qfu').value||0);
    const toda = Number($('#toda').value||0) || autoTODA;
    const lda  = Number($('#lda').value||0)  || autoLDA;
    const alt  = Number($('#alt').value||0);
    const oat  = Number($('#oat').value||0);
    const wdir = Number($('#windDir').value||0);
    const wkt  = Number($('#windKt').value||0);
    const extraTO= Number($('#extraTO').value||1);
    const extraLDG= Number($('#extraLDG').value||1);
    const safety = Number($('#safety').value||30);
    const tow   = Number($('#tow').value||900);
    const ldw   = Number($('#ldw').value||900);

    // ISA & ΔISA
    const isa = isaAt(alt);
    const deltaIsa = oat - isa;
    $('#isaText').textContent = `${isa.toFixed(1)} °C`;
    $('#deltaIsaText').textContent = `${deltaIsa.toFixed(1)} °C`;

    // Vent + composantes
    const comp = windComponents(qfu,wdir,wkt);
    const hw = comp.headwind;                 // + = face ; - = arrière
    const hwFace = Math.max(0, hw);
    const tw = Math.max(0, -hw);
    const xw = Math.abs(comp.crosswind);
    $('#hwFaceText').textContent = hwFace.toFixed(0);
    $('#twText').textContent = tw.toFixed(0);
    $('#xwText').textContent = xw.toFixed(0);

    // Limite travers 22 kt
    const crossLimit = 22;
    const warnEl = $('#xwWarn'); warnEl.textContent='';
    if(xw > crossLimit){
      warnEl.textContent = `⚠️ ${xw.toFixed(0)} kt > ${crossLimit} kt (limite DR400)`;
      warnEl.style.color = '#dc2626';
    } else {
      warnEl.style.color = 'var(--muted)';
    }

    // Interpolations (on calcule avec 15 m ; on affiche aussi le roulement)
    const baseTO_pass  = interpTO(alt, oat, tow, surface, 'pass');
    const baseTO_roll  = interpTO(alt, oat, tow, surface, 'roll');
    const baseLDG_pass = interpLDG(alt, oat, ldw, landingMode, 'pass');
    const baseLDG_roll = interpLDG(alt, oat, ldw, landingMode, 'roll');

    // Facteurs
    const windF = windDistanceFactor(hw); // Face → <1 ; Arrière → >1
    const spatF = withSpats ? 1.00 : 1.03;

    const toCalc = Math.round(baseTO_pass * windF * extraTO * spatF);
    const ldgCalc = Math.round(baseLDG_pass * windF * extraLDG);

    const toMargin  = Math.round(toCalc  * (1 + safety/100));
    const ldgMargin = Math.round(ldgCalc * (1 + safety/100));

    // Détails
    $('#toBasePass').textContent = Math.round(baseTO_pass)+' m';
    $('#toBaseRoll').textContent = Math.round(baseTO_roll)+' m';
    $('#toWindF').textContent = windF.toFixed(2)+'×';
    $('#toSpat').textContent = (spatF.toFixed(2)+'×') + (withSpats?' (carénages présents)':' (sans carénages)');
    $('#toExtra').textContent = extraTO.toFixed(2)+'×';
    $('#toRes').textContent = toCalc+' m';
    $('#toResM').textContent = toMargin+' m';

    $('#ldgBasePass').textContent = Math.round(baseLDG_pass)+' m';
    $('#ldgBaseRoll').textContent = Math.round(baseLDG_roll)+' m';
    $('#ldgWindF').textContent = windF.toFixed(2)+'×';
    $('#ldgExtra').textContent = extraLDG.toFixed(2)+'×';
    $('#ldgRes').textContent = ldgCalc+' m';
    $('#ldgResM').textContent = ldgMargin+' m';

    // KPI + chips
    $('#todaMini').textContent = toda? (toda+' m') : '—';
    $('#ldaMini').textContent  = lda?  (lda+' m')  : '—';

    const stTO = status(toMargin, toda);
    const stLDG = status(ldgMargin, lda);

    setChip(document.getElementById('toChip'), stTO);
    setChip(document.getElementById('ldgChip'), stLDG);

    setKpi(document.getElementById('toKpi'), stTO);
    setKpi(document.getElementById('ldgKpi'), stLDG);

    document.getElementById('toKpiVal').textContent  = toMargin+' m';
    document.getElementById('ldgKpiVal').textContent = ldgMargin+' m';
  }

  // Charge OurAirports FR au chargement (si réseau OK)
  loadOurAirportsFR().then(()=>compute());
</script>
</body>
</html>
