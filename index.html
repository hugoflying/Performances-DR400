<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CALCULCATEUR DE PERFORMANCES</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#6b7280;--ok:#16a34a;--bad:#dc2626;--line:#e5e7eb;--primary:#2563eb;--green:#16a34a;}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",Arial}
    h1{font-size:clamp(22px,3.5vw,30px);margin:0;text-align:center;letter-spacing:.02em}
    h2{font-size:18px;margin:0 0 .6rem 0}
    .center{text-align:center}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1200px){.row{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .btn{border:1px solid var(--line);background:#fff;padding:9px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.toggle.on{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.toggle.on.grass{background:var(--green)!important;border-color:var(--green)!important;color:#fff!important}
    .btn.block{width:100%;text-align:center;padding:12px 14px;border-radius:14px}
    label{display:block;font-size:12px;color:var(--muted)}
    input,select{width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .grid1{display:grid;grid-template-columns:1fr;gap:12px}
    .field{border:1px solid var(--line);border-radius:12px;background:#f8fafc;padding:10px}
    .field .k{font-size:12px;color:var(--muted)}
    .field .v{margin-top:4px;font-weight:600}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .note{font-size:12px;margin-top:6px}
    .hidden{display:none}
    .kpi{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:16px;padding:14px 16px;margin:8px 0}
    .kpi .left{display:flex;flex-direction:column}
    .kpi .title{font-size:12px;color:var(--muted);letter-spacing:.02em}
    .kpi .value{font-size:26px;font-weight:800;line-height:1.1}
    .kpi .sub{font-size:12px;color:var(--muted)}
    .kpi.ok{background:#ecfdf5;border-color:#86efac}
    .kpi.bad{background:#fef2f2;border-color:#fecaca}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid;font-weight:800}
    .chip.ok{background:#dcfce7;color:#14532d;border-color:#86efac}
    .chip.bad{background:#fee2e2;color:#7f1d1d;border-color:#fca5a5}
    .chip.neutral{background:#f3f4f6;color:#374151;border-color:#e5e7eb}
    #printRaw{display:none}
    @media print{
      #appRoot{display:none!important}
      #printRaw{display:block!important;padding:20mm;color:#000}
      #rawPre{white-space:pre;font:12pt/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
      body{background:#fff}
    }
  </style>
</head>
<body>
<div class="container" id="appRoot">
  <div class="header" style="justify-content:center;margin-bottom:8px">
    <h1>CALCULCATEUR DE PERFORMANCES</h1>
  </div>

  <section class="card" style="margin-top:4px">
    <h2>Paramètres généraux</h2>
    <div class="grid2">
      <label>Avion
        <select id="aircraftSel">
          <option value="F-GCAL (120cv)">F-GCAL (120cv)</option>
          <option value="F-BXEK (120cv)">F-BXEK (120cv)</option>
          <option value="F-BTKG (120cv)">F-BTKG (120cv)</option>
          <option value="F-BTXS (120cv)">F-BTXS (120cv)</option>
          <option value="F-BTBS (120cv)">F-BTBS (120cv)</option>
          <option value="F-BTBJ (108cv)">F-BTBJ (108cv)</option>
        </select>
      </label>
      <label>Hélice
        <input id="propeller" value="Sensenich" readonly />
      </label>
      <label>Marge sécurité (%)
        <input id="safety" type="number" value="30"/>
      </label>
      <div class="grid1">
        <label>Carénages de roues (décollage)</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="spatsWith" class="btn toggle on">Avec carénages de roues</button>
          <button id="spatsWithout" class="btn toggle">Sans carénages de roues</button>
        </div>
      </div>
    </div>
  </section>

  <div class="row" style="margin-top:12px">
    <!-- Départ -->
    <section class="card">
      <h2 class="center">Terrain de départ</h2>
      <div class="grid2">
        <label>ICAO départ
          <input id="depIcao" inputmode="latin" maxlength="4" placeholder="LFxx" />
        </label>
        <label>TODA (m)
          <input id="depToda" type="number" value="0"/>
        </label>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>QFU départ (°)
          <input id="depQfu" type="number" value="" placeholder="000–359"/>
        </label>
        <div>
          <button id="btnDepMetar" class="btn">Charger METAR</button>
          <div id="depMetarMsg" class="muted note"></div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>Élévation (ft)
          <input id="depAlt" type="number" value="0"/>
        </label>
        <label>OAT (°C)
          <input id="depOat" type="number" value="15"/>
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <label>Vent — Direction (° ou "VRB")
          <input id="depWindDir" type="text" inputmode="latin" placeholder="VRB ou 000" value="000" />
        </label>
        <label>Vent — Vitesse (kt)
          <input id="depWindKt" type="number" min="0" step="1" value="0"/>
        </label>
        <label>Rafales (kt)
          <input id="depWindGust" type="number" min="0" step="1" value="0"/>
        </label>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>VRB FROM (°) — optionnel
          <input id="depVrbFrom" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="ex: 350"/>
        </label>
        <label>VRB TO (°) — optionnel
          <input id="depVrbTo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="ex: 150"/>
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div class="field"><div class="k">Vent de face</div><div class="v"><span id="depHwFace">—</span> kt</div></div>
        <div class="field"><div class="k">Vent de travers</div><div class="v"><span id="depXw">—</span> kt</div></div>
        <div class="field"><div class="k">Vent arrière</div><div class="v"><span id="depTw">—</span> kt</div></div>
      </div>
      <div class="muted" id="depXwWarn" style="margin-top:6px"></div>

      <div class="grid2" style="margin-top:12px">
        <label>Masse au décollage (kg)
          <input id="depTow" type="number" value="900"/>
        </label>
        <label>Facteur suppl. décollage
          <input id="depExtraTO" type="number" step="0.01" value="1.00"/>
        </label>
      </div>

      <button id="btnCalcDep" class="btn primary block" style="margin-top:14px">Calculer les performances décollage</button>
    </section>

    <!-- Arrivée -->
    <section class="card">
      <h2 class="center">Terrain d'arrivée</h2>

      <div class="grid2">
        <label>ICAO arrivée
          <input id="arrIcao" inputmode="latin" maxlength="4" placeholder="LFxx" />
        </label>
        <label>LDA (m)
          <input id="arrLda" type="number" value="0"/>
        </label>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>QFU arrivée (°)
          <input id="arrQfu" type="number" value="" placeholder="000–359"/>
        </label>
        <div>
          <button id="btnArrMetar" class="btn">Charger METAR</button>
          <div id="arrMetarMsg" class="muted note"></div>
        </div>
      </div>

      <div class="grid1" style="margin-top:10px">
        <label>Atterrissage — mode</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="arrModerate" class="btn toggle on">Freinage modéré (dur/herbe)</button>
          <button id="arrNoBrake" class="btn toggle grass">Sans frein sur herbe</button>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>Élévation (ft)
          <input id="arrAlt" type="number" value="0"/>
        </label>
        <label>OAT (°C)
          <input id="arrOat" type="number" value="15"/>
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <label>Vent — Direction (° ou "VRB")
          <input id="arrWindDir" type="text" inputmode="latin" placeholder="VRB ou 000" value="000" />
        </label>
        <label>Vent — Vitesse (kt)
          <input id="arrWindKt" type="number" min="0" step="1" value="0"/>
        </label>
        <label>Rafales (kt)
          <input id="arrWindGust" type="number" min="0" step="1" value="0"/>
        </label>
      </div>

      <div class="grid2" style="margin-top:10px">
        <label>VRB FROM (°) — optionnel
          <input id="arrVrbFrom" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="ex: 350"/>
        </label>
        <label>VRB TO (°) — optionnel
          <input id="arrVrbTo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="ex: 150"/>
        </label>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div class="field"><div class="k">Vent de face</div><div class="v"><span id="arrHwFace">—</span> kt</div></div>
        <div class="field"><div class="k">Vent de travers</div><div class="v"><span id="arrXw">—</span> kt</div></div>
        <div class="field"><div class="k">Vent arrière</div><div class="v"><span id="arrTw">—</span> kt</div></div>
      </div>
      <div class="muted" id="arrXwWarn" style="margin-top:6px"></div>

      <div class="grid2" style="margin-top:12px">
        <label>Masse à l'atterrissage (kg)
          <input id="arrLdw" type="number" value="900"/>
        </label>
        <label>Facteur suppl. atterrissage
          <input id="arrExtraLDG" type="number" step="0.01" value="1.00"/>
        </label>
      </div>

      <button id="btnCalcArr" class="btn primary block" style="margin-top:14px">Calculer les performances atterrissage</button>
    </section>
  </div>

  <div class="row" style="margin-top:16px">
    <div class="card">
      <div class="header">
        <h2 class="center" style="width:100%">Décollage : performances calculées</h2>
        <span id="toChip" class="chip neutral">—</span>
      </div>
      <div id="toKpi" class="kpi">
        <div class="left">
          <span class="title">Requis (marge incluse)</span>
          <span class="value" id="toKpiVal">— m</span>
          <span class="sub">TODA dispo : <span id="todaMini">—</span></span>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="field"><div class="k">Passage des 15m (sans marge)</div><div id="toBasePass" class="v">—</div></div>
        <div class="field"><div class="k">Roulement (sans marge)</div><div id="toBaseRoll" class="v">—</div></div>
        <div class="field"><div class="k">Facteur vent</div><div id="toWindF" class="v">—</div></div>
        <div class="field"><div class="k">Carénages</div><div id="toSpat" class="v">—</div></div>
        <div class="field"><div class="k">Facteur supplémentaire</div><div id="toExtra" class="v">—</div></div>
        <div class="field"><div class="k">Résultat (sans marge)</div><div id="toRes" class="v">—</div></div>
        <div class="field"><div class="k">+ Marge</div><div id="toResM" class="v">—</div></div>
      </div>
    </div>

    <div class="card">
      <div class="header">
        <h2 class="center" style="width:100%">Atterrissage : performances calculées</h2>
        <span id="ldgChip" class="chip neutral">—</span>
      </div>
      <div id="ldgKpi" class="kpi">
        <div class="left">
          <span class="title">Requis (marge incluse)</span>
          <span class="value" id="ldgKpiVal">— m</span>
          <span class="sub">LDA dispo : <span id="ldaMini">—</span></span>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="field"><div class="k">Passage des 15m (sans marge)</div><div id="ldgBasePass" class="v">—</div></div>
        <div class="field"><div class="k">Roulement (sans marge)</div><div id="ldgBaseRoll" class="v">—</div></div>
        <div class="field"><div class="k">Facteur vent</div><div id="ldgWindF" class="v">—</div></div>
        <div class="field"><div class="k">Facteur supplémentaire</div><div id="ldgExtra" class="v">—</div></div>
        <div class="field"><div class="k">Résultat (sans marge)</div><div id="ldgRes" class="v">—</div></div>
        <div class="field"><div class="k">+ Marge</div><div id="ldgResM" class="v">—</div></div>
      </div>
    </div>
  </div>

  <div class="muted center" style="margin-top:12px">Source : Manuel de vol - Aéroclub de Beauvais-Tillé</div>
</div>

<section id="printRaw"><pre id="rawPre"></pre></section>

<script>
  /* ===================== DONNÉES (inchangé) ===================== */
  const TO_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},hard:{kg700:{roll:[130,145,165],pass:[285,315,345]},kg900:{roll:[225,235,285],pass:[480,535,590]}},grass:{kg700:{roll:[165,185,215],pass:[320,355,395]},kg900:{roll:[315,360,410],pass:[570,640,715]}}},4000:{temps:{minus20:-13,isa:7,plus20:27},hard:{kg700:{roll:[175,195,220],pass:[375,415,460]},kg900:{roll:[305,345,390],pass:[645,720,800]}},grass:{kg700:{roll:[230,265,300],pass:[430,485,540]},kg900:{roll:[460,530,615],pass:[800,905,1025]}}},8000:{temps:{minus20:-21,isa:-1,plus20:19},hard:{kg700:{roll:[235,265,300],pass:[500,560,620]},kg900:{roll:[425,475,535],pass:[890,1000,1125]}},grass:{kg700:{roll:[330,380,440],pass:[595,675,760]},kg900:{roll:[700,820,960],pass:[1165,1350,1550]}}}};
  const LDG_DR400={0:{temps:{minus20:-5,isa:15,plus20:35},moderate:{kg700:{roll:[145,155,165],pass:[365,385,400]},kg900:{roll:[185,200,210],pass:[435,460,485]}},nobrake_grass:{kg700:{roll:[215,230,250],pass:[435,460,485]},kg900:{roll:[280,300,325],pass:[530,560,590]} }},4000:{temps:{minus20:-13,isa:7,plus20:27},moderate:{kg700:{roll:[160,175,185],pass:[395,420,440]},kg900:{roll:[205,225,240],pass:[475,505,535]}},nobrake_grass:{kg700:{roll:[240,260,285],pass:[475,505,530]},kg900:{roll:[310,335,360],pass:[580,615,655]}}},8000:{temps:{minus20:-21,isa:-1,plus20:19},moderate:{kg700:{roll:[180,195,210],pass:[430,460,485]},kg900:{roll:[235,250,270],pass:[525,555,590]}},nobrake_grass:{kg700:{roll:[275,290,315],pass:[525,555,590]},kg900:{roll:[350,375,405],pass:[640,680,725]}}}};
  const DR300_TEMPS=[0,15,30,45];
  const TO_DR300 = {
    hard: { alts:[0,1500,3000,4500],
      roll: [[315,350,390,430],[330,360,400,460],[385,430,475,520],[430,480,520,560]],
      pass: [[530,590,655,720],[605,675,745,820],[685,765,845,920],[760,845,935,1020]],
    },
    grass: { alts:[0,1500,3000,4600],
      roll: [[380,420,470,515],[420,470,515,575],[455,510,570,625],[510,575,635,695]],
      pass: [[595,660,735,805],[675,745,820,895],[760,850,935,1025],[845,940,1040,1135]],
    },
    massScale: m => Math.min(1, m/1000)
  };

  /* ===================== UTILITAIRES ===================== */
  const $=s=>document.querySelector(s);
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const lerp=(x0,y0,x1,y1,x)=> y0 + (y1-y0)*((x-x0)/(x1-x0||1));
  const pad3=n=>String(Math.round(n)).padStart(3,'0');
  const toRad=d=>d*Math.PI/180;
  const cosd=d=>Math.cos(toRad(d));
  const sind=d=>Math.sin(toRad(d));
  const angDiff=(a,b)=>{ let d=((a-b+540)%360)-180; return d; };
  const inConeFace=(dir,qfu)=> Math.abs(angDiff(dir,qfu))<=90;

  /* ===================== Sélection avion & options ===================== */
  let depSurface='hard',arrSurface='hard',landingMode='moderate',withSpats=true, profile='DR400';
  const propByAircraft={
    'F-GCAL (120cv)':'Sensenich','F-BXEK (120cv)':'Sensenich','F-BTKG (120cv)':'Sensenich','F-BTXS (120cv)':'Sensenich',
    'F-BTBS (120cv)':'Mac Cauley','F-BTBJ (108cv)':'Mac Cauley'
  };
  function onAircraftChange(){
    const ac=$('#aircraftSel').value;
    $('#propeller').value=propByAircraft[ac]||'';
    profile = (ac.startsWith('F-BTKG') || ac.startsWith('F-BTXS')) ? 'DR300' : 'DR400';
    updateWindAndWarnings();
  }
  $('#aircraftSel').addEventListener('change', onAircraftChange);
  $('#spatsWith').onclick=()=>{withSpats=true;$('#spatsWith').classList.add('on');$('#spatsWithout').classList.remove('on');};
  $('#spatsWithout').onclick=()=>{withSpats=false;$('#spatsWithout').classList.add('on');$('#spatsWith').classList.remove('on');};
  $('#arrModerate').onclick=()=>{landingMode='moderate';$('#arrModerate').classList.add('on');$('#arrNoBrake').classList.remove('on');};
  $('#arrNoBrake').onclick=()=>{landingMode='nobrake_grass';$('#arrNoBrake').classList.add('on');$('#arrModerate').classList.remove('on');};

  function sanitizeIcao(el){el.value=(el.value||'').toUpperCase().replace(/[^A-Z]/g,'').slice(0,4)}
  ['depIcao','arrIcao'].forEach(id=>{
    const el=$('#'+id);
    el.addEventListener('input',()=>{sanitizeIcao(el);});
    el.addEventListener('blur',()=>sanitizeIcao(el));
  });

  /* ===================== METAR (AVWX) ===================== */
  const AVWX_TOKEN = 'q45JCSdkFjeZqHUyvawV2iaFm80CYmlPP6kC3XS8VNs';

  async function fetchMetar(icao){
    if(!icao || icao.length!==4) throw new Error('ICAO invalide');
    const url=`https://avwx.rest/api/metar/${icao}`;
    const resp = await fetch(url,{ headers:{ Authorization:'BEARER '+AVWX_TOKEN }});
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    return await resp.json();
  }

  function parseVarSector(data){
    const repr = data?.variable_direction?.repr || '';
    const m = /^(\d{3})V(\d{3})$/.exec(repr);
    if(m){ return {from:parseInt(m[1],10), to:parseInt(m[2],10)}; }
    return null;
  }

  function applyMetar(side, data){
    // Exemples METAR: "VRB03KT" | "36020KT 350V150" | "27010G25KT"
    const dirRepr = (data?.wind_direction?.repr ?? '');
    const dirVal = (data?.wind_direction?.value ?? null);
    const spdVal = Math.max(0, Math.round(data?.wind_speed?.value ?? 0));
    const gustVal = Math.max(0, Math.round(data?.wind_gust?.value ?? 0));
    const oatVal = Math.round(data?.temperature?.value ?? 15);
    const sector = parseVarSector(data);

    // Direction: "VRB" ou cap
    const dirEl = document.getElementById(side+'WindDir');
    if(dirRepr==='VRB'){ dirEl.value='VRB'; }
    else if(dirVal!==null){ dirEl.value = pad3(dirVal); }

    // Vitesse & rafales
    document.getElementById(side+'WindKt').value = String(spdVal);
    document.getElementById(side+'WindGust').value = String(gustVal||0);

    // OAT
    document.getElementById(side+'Oat').value = String(oatVal);

    // Secteur VRB si présent
    if(sector){
      document.getElementById(side+'VrbFrom').value = pad3(sector.from);
      document.getElementById(side+'VrbTo').value   = pad3(sector.to);
    }else{
      // ne vide pas forcément les champs : l’utilisateur peut saisir à la main
    }

    // Message brut lisible
    const usedDir = (dirRepr==='VRB') ? 'VRB' : (dirVal!==null?pad3(dirVal):'—');
    const gustTxt = gustVal? ` G${gustVal}`:'';
    const varTxt = sector? ` · VAR ${pad3(sector.from)}V${pad3(sector.to)}`:'';
    const msgEl = document.getElementById(side==='dep'?'depMetarMsg':'arrMetarMsg');
    msgEl.textContent = `METAR chargé : ${usedDir}${gustTxt} · ${spdVal} kt · OAT ${oatVal} °C${varTxt}`;

    updateWindAndWarnings();
  }

  async function loadMetarFor(side){
    const icaoEl = document.getElementById(side+'Icao');
    const icao = (icaoEl.value||'').toUpperCase();
    const msgEl = document.getElementById(side==='dep'?'depMetarMsg':'arrMetarMsg');
    msgEl.textContent = 'Chargement METAR…';
    try{
      const data = await fetchMetar(icao);
      applyMetar(side, data);
    }catch(e){
      msgEl.textContent = 'METAR indisponible ('+(e.message||'erreur')+')';
    }
  }
  document.getElementById('btnDepMetar').addEventListener('click', ()=>loadMetarFor('dep'));
  document.getElementById('btnArrMetar').addEventListener('click', ()=>loadMetarFor('arr'));

  /* ===================== LECTURE VENT & VRB MANUEL ===================== */
  function parseDirField(val){
    if(!val) return {isVRB:false, dir:null};
    const t = val.trim().toUpperCase();
    if(t==='VRB') return {isVRB:true, dir:null};
    const n = parseInt(t.replace(/\D/g,''),10);
    if(isNaN(n)) return {isVRB:false, dir:null};
    return {isVRB:false, dir:clamp(n,0,359)};
  }
  function readVrbSector(side){
    const f = parseInt(($('#'+side+'VrbFrom').value||'').replace(/\D/g,''),10);
    const t = parseInt(($('#'+side+'VrbTo').value||'').replace(/\D/g,''),10);
    const from = isNaN(f)? null : clamp(f,0,359);
    const to   = isNaN(t)? null : clamp(t,0,359);
    if(from===null || to===null) return {has:false, from:null, to:null};
    return {has:true, from, to};
  }

  /* ====== Règle « pire cas » (comme défini) ====== */
  function worstWindForPerfAndLimit(qfu, dirField, kt, gust, sector){
    const V = Math.max(0, kt|0);
    const G = Math.max(V, gust|0);
    const noQFU = (qfu===null || qfu===undefined || qfu==='');
    if(noQFU) return null;

    function compsFor(dir, speed){
      const d = Math.abs(((dir-qfu+540)%360)-180);
      const hwSigned = speed * cosd(d);
      const xw = Math.abs(speed * sind(d));
      return { d, hwSigned, xw };
    }

    // CAS 1 : VRB (direction = VRB) OU secteur VRB saisi
    if(dirField.isVRB || sector.has){
      // Y-a-t-il possibilité d’avoir du vent arrière ?
      let canBeTail = true;
      if(sector.has){
        // tester quelques angles du secteur
        const candidates = [sector.from, sector.to, (sector.from+sector.to)/2, (sector.from+sector.to+360)/2 % 360];
        canBeTail = candidates.some(a => Math.abs(((a-qfu+540)%360)-180) > 90);
      } // sans secteur → on considère que ça peut devenir arrière selon ta règle

      if(canBeTail){
        // PIRE CAS arrière : utiliser GUST/MAX
        let bestTw = 0;
        const dirs = sector.has ? [sector.from, sector.to] : [ (qfu+180)%360 ];
        dirs.forEach(d=>{
          const c = compsFor(d, G);
          bestTw = Math.max(bestTw, Math.max(0, -c.hwSigned));
        });
        return {
          hwFace: 0,
          tw: Math.round(bestTw),
          xwShown: 0,
          headwindForFactor: -bestTw,         // pour facteur distance
          crossForLimit: Math.round(G),       // limite travers: pire 90° avec vitesse max/rafale
        };
      }else{
        // Jamais arrière → prendre la face minimale (bord le plus défavorable), SANS rafale
        const c1 = compsFor(sector.from, V);
        const c2 = compsFor(sector.to,   V);
        const edge = (Math.abs(c1.hwSigned) < Math.abs(c2.hwSigned)) ? c1 : c2;
        const hwFace = Math.max(0, edge.hwSigned);
        return {
          hwFace: Math.round(hwFace),
          tw: 0,
          xwShown: Math.round(edge.xw),
          headwindForFactor: hwFace,          // facteur distance
          crossForLimit: Math.round(G),       // limite travers: pire 90° avec vitesse max/rafale
        };
      }
    }

    // CAS 2 : Direction fixe (numérique)
    if(dirField.dir!==null){
      const c = compsFor(dirField.dir, V);
      if(c.hwSigned >= 0){
        // tout face → utiliser V (pas de rafale)
        return {
          hwFace: Math.round(c.hwSigned),
          tw: 0,
          xwShown: Math.round(c.xw),
          headwindForFactor: c.hwSigned,
          crossForLimit: Math.round(Math.max(V,G)), // limite travers avec vitesse max
        };
      }else{
        // légèrement arrière → utiliser la rafale / Vmax
        const cMax = compsFor(dirField.dir, G);
        return {
          hwFace: 0,
          tw: Math.round(Math.abs(cMax.hwSigned)),
          xwShown: 0,
          headwindForFactor: cMax.hwSigned,
          crossForLimit: Math.round(Math.max(c.xw, Math.abs(G*sind(90)))),
        };
      }
    }

    // Pas exploitable
    return {
      hwFace: 0, tw: 0, xwShown: 0, headwindForFactor: 0, crossForLimit: 0
    };
  }

  function windDistanceFactor(head){
    if(head>=0){
      const pts=[{x:0,y:1.00},{x:10,y:0.78},{x:20,y:0.63},{x:30,y:0.52}],x=Math.max(0,Math.min(30,head));
      if(x===0)return 1;
      for(let i=0;i<pts.length-1;i++){
        const p0=pts[i],p1=pts[i+1];
        if(x>=p0.x&&x<=p1.x) return p0.y+(p1.y-p0.y)*((x-p0.x)/(p1.x-p0.x));
      }
      return pts.at(-1).y;
    }else{
      const tw=Math.abs(head),steps=Math.ceil(tw/2);
      return 1+0.10*steps;
    }
  }

  /* ===================== Interpolations perfs (inchangé) ===================== */
  function interpTemp(rowTemps,arr,oat){
    const xs=[rowTemps.minus20,rowTemps.isa,rowTemps.plus20],ys=arr;
    if(oat<=xs[0])return ys[0]; if(oat>=xs[2])return ys[2];
    if(oat<=xs[1])return lerp(xs[0],ys[0],xs[1],ys[1],oat);
    return lerp(xs[1],ys[1],xs[2],ys[2],oat);
  }
  function interpTO_DR400(altFt,oat,massKg,surface,kind){
    const low=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    const high=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    const alpha=clamp((massKg-700)/(900-700),0,1);
    const valAt=alt=>{
      const t=TO_DR400[alt];
      const v700=interpTemp(t.temps,t[surface].kg700[kind],oat);
      const v900=interpTemp(t.temps,t[surface].kg900[kind],oat);
      return lerp(0,v700,1,v900,alpha);
    };
    if(low===high)return valAt(low);
    return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function interpLDG_DR400(altFt,oat,massKg,mode,kind){
    const low=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?0:4000);
    const high=altFt<=0?0:altFt>=8000?8000:(altFt<=4000?4000:8000);
    const alpha=clamp((massKg-700)/(900-700),0,1);
    const valAt=alt=>{
      const t=LDG_DR400[alt];
      const v700=interpTemp(t.temps,t[mode].kg700[kind],oat);
      const v900=interpTemp(t.temps,t[mode].kg900[kind],oat);
      return lerp(0,v700,1,v900,alpha);
    };
    if(low===high)return valAt(low);
    return lerp(low,valAt(low),high,valAt(high),altFt);
  }
  function interpGridDR300(surface,kind,altFt,oat,massKg){
    const surf=TO_DR300[surface], temps=DR300_TEMPS, alts=surf.alts;
    function interpRow(row){
      const ys=row,x=oat;
      if(x<=temps[0])return ys[0];
      if(x>=temps[3])return ys[3];
      if(x<=temps[1])return lerp(temps[0],ys[0],temps[1],ys[1],x);
      if(x<=temps[2])return lerp(temps[1],ys[1],temps[2],ys[2],x);
      return lerp(temps[2],ys[2],temps[3],ys[3],x);
    }
    let a0=alts[0], a1=alts[alts.length-1];
    for(let i=0;i<alts.length-1;i++){
      if(altFt<=alts[0]){a0=a1=alts[0];break;}
      if(altFt>=alts[alts.length-1]){a0=a1=alts[alts.length-1];break;}
      if(altFt>=alts[i] && altFt<=alts[i+1]){a0=alts[i];a1=alts[i+1];break;}
    }
    const idx0=alts.indexOf(a0), idx1=alts.indexOf(a1);
    const v0=interpRow(surf[kind][idx0]);
    const v1=interpRow(surf[kind][idx1]);
    let val=(a0===a1)?v0:lerp(a0,v0,a1,v1,altFt);
    return val*TO_DR300.massScale(massKg);
  }

  /* ===================== MISE À JOUR COMPOSANTES (auto) ===================== */
  function padDirField(id){
    const el=$('#'+id);
    const t=(el.value||'').trim().toUpperCase();
    if(t==='VRB'||t==='') return;
    let n=parseInt(t.replace(/\D/g,''),10);
    if(isNaN(n)) n=0;
    n=Math.max(0,Math.min(359,n));
    el.value=pad3(n);
  }

  ['depWindDir','arrWindDir','depWindKt','arrWindKt','depWindGust','arrWindGust',
   'depVrbFrom','arrVrbFrom','depVrbTo','arrVrbTo','depQfu','arrQfu','depOat','arrOat'
  ].forEach(id=>{
    const el=$('#'+id);
    el.addEventListener('input', updateWindAndWarnings);
    el.addEventListener('blur', ()=>{ if(id.endsWith('WindDir')||id.includes('Vrb')) padDirField(id); updateWindAndWarnings(); });
  });

  function updateWindAndWarnings(){
    const crossLimit=22;

    // ----- DEPART -----
    const depQfuRaw=$('#depQfu').value;
    const depQfu = (depQfuRaw===''? null : +depQfuRaw);
    const dField = parseDirField($('#depWindDir').value);
    const dKt    = Math.max(0, parseInt($('#depWindKt').value||'0',10));
    const dGust  = Math.max(0, parseInt($('#depWindGust').value||'0',10));
    const dSect  = readVrbSector('dep');

    if(depQfu===null){
      $('#depHwFace').textContent='—'; $('#depXw').textContent='—'; $('#depTw').textContent='—';
      $('#depXwWarn').textContent=''; $('#todaMini').textContent=($('#depToda').value?$('#depToda').value+' m':'—');
    }else{
      const w = worstWindForPerfAndLimit(depQfu, dField, dKt, dGust, dSect);
      $('#depHwFace').textContent = w? w.hwFace.toFixed(0):'—';
      $('#depXw').textContent     = w? w.xwShown.toFixed(0):'—';
      $('#depTw').textContent     = w? w.tw.toFixed(0):'—';
      const depWarn=$('#depXwWarn');
      const crossForLimit = w? w.crossForLimit:0;
      depWarn.textContent = (w && crossForLimit>crossLimit)?`⚠️ ${crossForLimit} kt > ${crossLimit} kt (limite DR400)`:'';
      depWarn.style.color = (w && crossForLimit>crossLimit)?'#dc2626':'var(--muted)';
      $('#todaMini').textContent=($('#depToda').value?$('#depToda').value+' m':'—');
    }

    // ----- ARRIVEE -----
    const arrQfuRaw=$('#arrQfu').value;
    const arrQfu = (arrQfuRaw===''? null : +arrQfuRaw);
    const aField = parseDirField($('#arrWindDir').value);
    const aKt    = Math.max(0, parseInt($('#arrWindKt').value||'0',10));
    const aGust  = Math.max(0, parseInt($('#arrWindGust').value||'0',10));
    const aSect  = readVrbSector('arr');

    if(arrQfu===null){
      $('#arrHwFace').textContent='—'; $('#arrXw').textContent='—'; $('#arrTw').textContent='—';
      $('#arrXwWarn').textContent=''; $('#ldaMini').textContent=($('#arrLda').value?$('#arrLda').value+' m':'—');
    }else{
      const wA = worstWindForPerfAndLimit(arrQfu, aField, aKt, aGust, aSect);
      $('#arrHwFace').textContent = wA? wA.hwFace.toFixed(0):'—';
      $('#arrXw').textContent     = wA? wA.xwShown.toFixed(0):'—';
      $('#arrTw').textContent     = wA? wA.tw.toFixed(0):'—';
      const arrWarn=$('#arrXwWarn');
      const crossForLimitA = wA? wA.crossForLimit:0;
      arrWarn.textContent = (wA && crossForLimitA>crossLimit)?`⚠️ ${crossForLimitA} kt > ${crossLimit} kt (limite DR400)`:'';
      arrWarn.style.color = (wA && crossForLimitA>crossLimit)?'#dc2626':'var(--muted)';
      $('#ldaMini').textContent=($('#arrLda').value?$('#arrLda').value+' m':'—');
    }
  }

  /* ===================== CALCUL DES PERFS (boutons) ===================== */
  function computeDepPerf(){
    const depQfuRaw=$('#depQfu').value;
    const depQfu = (depQfuRaw===''? null : +depQfuRaw);
    if(depQfu===null){
      setChip($('#toChip'),'neutral'); setKpi($('#toKpi'),'');
      $('#toBasePass').textContent='—'; $('#toBaseRoll').textContent='—';
      $('#toWindF').textContent='—'; $('#toSpat').textContent='—'; $('#toExtra').textContent='—';
      $('#toRes').textContent='—'; $('#toResM').textContent='—';
      return;
    }
    const depAlt=+($('#depAlt').value||0), depOat=+($('#depOat').value||0),
          depExtra=+($('#depExtraTO').value||1), depTow=+($('#depTow').value||900),
          depToda=+($('#depToda').value||0), safety=+($('#safety').value||30);

    const dField = parseDirField($('#depWindDir').value);
    const dKt    = Math.max(0, parseInt($('#depWindKt').value||'0',10));
    const dGust  = Math.max(0, parseInt($('#depWindGust').value||'0',10));
    const dSect  = readVrbSector('dep');
    const w = worstWindForPerfAndLimit(depQfu, dField, dKt, dGust, dSect);

    let baseTO_pass, baseTO_roll;
    if(profile==='DR300'){
      baseTO_pass = interpGridDR300(depSurface,'pass',depAlt,depOat,depTow);
      baseTO_roll = interpGridDR300(depSurface,'roll',depAlt,depOat,depTow);
    }else{
      baseTO_pass = interpTO_DR400(depAlt,depOat,depTow,depSurface,'pass');
      baseTO_roll = interpTO_DR400(depAlt,depOat,depTow,depSurface,'roll');
    }
    const depWindF = windDistanceFactor(w.headwindForFactor);
    const spatsF=withSpats?1.00:1.03;
    const toCalc=Math.round(baseTO_pass*depWindF*depExtra*spatsF);
    const toMargin=Math.round(toCalc*(1+safety/100));

    $('#toBasePass').textContent=Math.round(baseTO_pass)+' m';
    $('#toBaseRoll').textContent=Math.round(baseTO_roll)+' m';
    $('#toWindF').textContent=depWindF.toFixed(2)+'×';
    $('#toSpat').textContent=`${spatsF.toFixed(2)}×`+(spatsF===1?' (carénages présents)':' (sans carénages)');
    $('#toExtra').textContent=depExtra.toFixed(2)+'×';
    $('#toRes').textContent=toCalc+' m';
    $('#toResM').textContent=toMargin+' m';
    $('#todaMini').textContent=($('#depToda').value?$('#depToda').value+' m':'—');

    const stTO=(depToda? (toMargin<=depToda?'ok':'bad'):'neutral');
    setChip($('#toChip'),stTO); setKpi($('#toKpi'),stTO);
    $('#toKpiVal').textContent=toMargin+' m';
  }

  function computeArrPerf(){
    const arrQfuRaw=$('#arrQfu').value;
    const arrQfu = (arrQfuRaw===''? null : +arrQfuRaw);
    if(arrQfu===null){
      setChip($('#ldgChip'),'neutral'); setKpi($('#ldgKpi'),'');
      $('#ldgBasePass').textContent='—'; $('#ldgBaseRoll').textContent='—';
      $('#ldgWindF').textContent='—'; $('#ldgExtra').textContent=$('#arrExtraLDG').value? (+$('#arrExtraLDG').value).toFixed(2)+'×':'—';
      $('#ldgRes').textContent='—'; $('#ldgResM').textContent='—';
      return;
    }
    const arrAlt=+($('#arrAlt').value||0), arrOat=+($('#arrOat').value||0),
          arrExtra=+($('#arrExtraLDG').value||1), arrLdw=+($('#arrLdw').value||900),
          arrLda=+($('#arrLda').value||0), safety=+($('#safety').value||30);

    const aField = parseDirField($('#arrWindDir').value);
    const aKt    = Math.max(0, parseInt($('#arrWindKt').value||'0',10));
    const aGust  = Math.max(0, parseInt($('#arrWindGust').value||'0',10));
    const aSect  = readVrbSector('arr');
    const wA = worstWindForPerfAndLimit(arrQfu, aField, aKt, aGust, aSect);

    const baseLDG_pass = interpLDG_DR400(arrAlt,arrOat,arrLdw,landingMode,'pass');
    const baseLDG_roll = interpLDG_DR400(arrAlt,arrOat,arrLdw,landingMode,'roll');
    const arrWindF = windDistanceFactor(wA.headwindForFactor);
    const ldgCalc=Math.round(baseLDG_pass*arrWindF*arrExtra);
    const ldgMargin=Math.round(ldgCalc*(1+safety/100));

    $('#ldgBasePass').textContent=Math.round(baseLDG_pass)+' m';
    $('#ldgBaseRoll').textContent=Math.round(baseLDG_roll)+' m';
    $('#ldgWindF').textContent=arrWindF.toFixed(2)+'×';
    $('#ldgExtra').textContent=arrExtra.toFixed(2)+'×';
    $('#ldgRes').textContent=ldgCalc+' m';
    $('#ldgResM').textContent=ldgMargin+' m';
    $('#ldaMini').textContent=($('#arrLda').value?$('#arrLda').value+' m':'—');

    const stLDG=(arrLda? (ldgMargin<=arrLda?'ok':'bad'):'neutral');
    setChip($('#ldgChip'),stLDG); setKpi($('#ldgKpi'),stLDG);
    $('#ldgKpiVal').textContent=ldgMargin+' m';
  }

  // Boutons "Calculer"
  document.getElementById('btnCalcDep').addEventListener('click', computeDepPerf);
  document.getElementById('btnCalcArr').addEventListener('click', computeArrPerf);

  // Mise à jour auto des composantes vent à la saisie
  updateWindAndWarnings();

  // Impression simple
  function setChip(el,state){el.className='chip '+(state==='ok'?'ok':state==='bad'?'bad':'neutral');el.textContent=state==='ok'?'OK':state==='bad'?'KO':'—'}
  function setKpi(el,state){el.className='kpi '+(state==='ok'?'ok':state==='bad'?'bad':'')}

  function buildRawReport(){
    const ts=new Date().toLocaleString('fr-FR');
    return [`CALCULCATEUR DE PERFORMANCES`,`Horodatage : ${ts}`].join('\n');
  }
  window.addEventListener('beforeprint', ()=>{document.getElementById('rawPre').textContent = buildRawReport();});
</script>
</body>
</html>
